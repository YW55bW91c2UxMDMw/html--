<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOCHAN - Anon Space</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* ğŸŒŒ [JindoStar ìš°ì£¼ í…Œë§ˆ] */
        :root {
            --bg-deep: #050510;
            --accent: #00d4ff;       
            --glass-bg: rgba(20, 20, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sub: #a4a4c5;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', monospace;
            background-color: var(--bg-deep);
            color: var(--text-main);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            min-height: 100vh;
        }

        a { color: var(--text-sub); text-decoration: none; }
        
        /* ìƒë‹¨ ë°” */
        .top-bar {
            padding: 15px 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border); font-size: 0.9rem;
            display: flex; gap: 15px; position: fixed; top: 0; width: 100%; z-index: 100;
        }

        .container { max-width: 1200px; margin: 80px auto 40px auto; padding: 0 15px; }

        /* ê¸€ì“°ê¸° í¼ */
        .post-form {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 20px; margin-bottom: 40px; max-width: 800px; margin-left: auto; margin-right: auto;
        }
        
        input[type="text"], input[type="password"], textarea {
            width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid #333; border-radius: 4px;
            color: white; padding: 10px; font-family: 'Pretendard', monospace; outline: none;
        }
        input:focus, textarea:focus { border-color: var(--accent); }
        
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì»¤ìŠ¤í…€ */
        .file-upload-box {
            flex: 2; display: flex; align-items: center; background: rgba(0,0,0,0.3);
            border: 1px solid #333; border-radius: 4px; padding: 5px;
        }
        .file-btn {
            background: #333; color: #ccc; padding: 8px 15px; border-radius: 4px;
            cursor: pointer; font-size: 0.9rem; border: 1px solid #555; margin-right: 10px; white-space: nowrap;
        }
        .file-btn:hover { background: #555; color: white; border-color: var(--accent); }
        .file-name { color: #666; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .btn-submit {
            flex: 1; padding: 12px; background: linear-gradient(45deg, var(--accent), #0066ff);
            color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; white-space: nowrap;
        }

        /* ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ */
        #thread-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;
        }

        .thread-card {
            background: rgba(30, 30, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px; overflow: hidden; transition: 0.3s; cursor: pointer;
            display: flex; flex-direction: column; height: 350px;
        }
        .thread-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2); border-color: var(--accent); }

        .card-thumb { width: 100%; height: 180px; object-fit: cover; background: #000; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .no-image-thumb {
            width: 100%; height: 180px; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); color: #444; font-size: 0.8rem;
        }

        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.1rem; font-weight: bold; color: #fff; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 10px; display: flex; justify-content: space-between; }
        .card-preview { font-size: 0.85rem; color: #aaa; line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

        /* ğŸ“Œ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ (íŒì—…) */
        .post-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            overflow-y: auto; padding: 20px; backdrop-filter: blur(5px);
        }
        .modal-container {
            max-width: 800px; margin: 50px auto;
            background: #16161e; border: 1px solid var(--accent);
            border-radius: 10px; box-shadow: 0 0 50px rgba(0,212,255,0.1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* ëª¨ë‹¬ í—¤ë”/ë³¸ë¬¸/í‘¸í„° ë¶„ë¦¬ */
        .modal-body { padding: 30px; }
        .modal-close { float: right; font-size: 2rem; cursor: pointer; color: #fff; margin-top: -10px; }
        
        /* [NEW] ëª¨ë‹¬ í•˜ë‹¨ (ëŒ“ê¸€ì…ë ¥ + ì‚­ì œë²„íŠ¼) */
        .modal-footer {
            background: #111;
            border-top: 1px solid #333;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* ì–‘ë ì •ë ¬ */
            gap: 20px;
        }
        
        .reply-input-area { display: flex; flex: 1; gap: 10px; }
        .reply-btn { background: var(--accent); border: none; padding: 0 20px; color: black; font-weight: bold; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        
        .delete-btn {
            background: transparent; border: 1px solid #ff4f4f; color: #ff4f4f;
            padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
            white-space: nowrap; transition: 0.3s;
        }
        .delete-btn:hover { background: #ff4f4f; color: white; }

        .greentext { color: #a6e22e; }
        .loading { text-align: center; color: var(--accent); animation: blink 1s infinite; width: 100%; grid-column: 1 / -1; }
        @keyframes blink { 50% { opacity: 0.3; } }

    </style>
</head>
<body>

    <nav class="top-bar">
        <a href="/">ë©”ì¸ í˜ì´ì§€</a>
        <a href="/board.html" style="color:var(--accent); font-weight:bold;">/b/ ìµëª…ì±„ë„</a>
    </nav>

    <div class="container">
        <div style="text-align:center; margin-bottom:40px;">
            <h1 style="margin:0; color:var(--accent); font-size:2.5rem; letter-spacing:2px;">/BOARD/</h1>
            <div style="color:#666; font-size:0.9rem;">Anonymous Image Board v3.2</div>
        </div>

        <div class="post-form">
            <div class="form-row">
                <input type="text" id="input-name" placeholder="ë‹‰ë„¤ì„ (ë¹„ìš°ë©´ ìµëª…)" style="flex: 1;">
                <input type="password" id="input-password" placeholder="ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)" style="flex: 1;">
            </div>
            <div class="form-row">
                <input type="text" id="input-subject" placeholder="ì œëª© (ì„ íƒì‚¬í•­)">
            </div>
            <div class="form-row">
                <textarea id="input-comment" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <div class="form-row" style="align-items: stretch;">
                <div class="file-upload-box">
                    <input type="file" id="input-file" style="display: none;" onchange="updateFileName()">
                    <label for="input-file" class="file-btn">ğŸ“ íŒŒì¼ ì„ íƒ</label>
                    <span id="file-name" class="file-name">No File Selected</span>
                </div>
                <button class="btn-submit" onclick="submitPost()">ì „ì†¡ (UPLOAD)</button>
            </div>
        </div>

        <div id="thread-list">
            <div class="loading">/// RECEIVING DATA... ///</div>
        </div>
    </div>

    <div id="post-modal" class="post-modal" onclick="closeModal(event)">
        <div class="modal-container">
            
            <div class="modal-body">
                <span class="modal-close" onclick="document.getElementById('post-modal').style.display='none'">&times;</span>
                <div id="modal-content"></div>
                <div id="modal-replies"></div>
            </div>

            <div class="modal-footer">
                <div class="reply-input-area">
                    <input type="text" id="reply-input" placeholder="ìµëª… ëŒ“ê¸€ ë‹¬ê¸°...">
                    <button class="reply-btn" onclick="submitReply()">ë“±ë¡</button>
                </div>
                <button class="delete-btn" id="modal-delete-btn">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>

        </div>
    </div>

    <script>
        // =================================================
        // [í•„ìˆ˜] ë³¸ì¸ì˜ Supabase í‚¤ë¡œ êµì²´í•˜ì„¸ìš”!
        // =================================================
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4'
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        function updateFileName() {
            const fileInput = document.getElementById('input-file');
            const fileNameSpan = document.getElementById('file-name');
            if (fileInput.files.length > 0) {
                fileNameSpan.textContent = fileInput.files[0].name;
                fileNameSpan.style.color = 'var(--accent)';
            } else {
                fileNameSpan.textContent = 'No File Selected';
                fileNameSpan.style.color = '#666';
            }
        }

        async function loadPosts() {
            const { data, error } = await client
                .from('board_posts')
                .select('*')
                .order('created_at', { ascending: false });

            const list = document.getElementById('thread-list');
            list.innerHTML = '';

            if (error) return list.innerHTML = `<div style="color:red; text-align:center;">ë¡œë”© ì‹¤íŒ¨</div>`;

            window.allPosts = data;

            data.forEach(post => {
                if (post.parent_id === null) {
                    const card = document.createElement('div');
                    card.className = 'thread-card';
                    card.onclick = () => openModal(post.id);

                    let thumbHtml = post.image_url 
                        ? `<img src="${post.image_url}" class="card-thumb">` 
                        : `<div class="no-image-thumb">NO IMAGE</div>`;
                    
                    card.innerHTML = `
                        ${thumbHtml}
                        <div class="card-content">
                            <div class="card-title">${post.subject || 'ë¬´ì œ'}</div>
                            <div class="card-meta">
                                <span>${post.name || 'Anonymous'}</span>
                                <span>${new Date(post.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="card-preview">${post.content}</div>
                        </div>
                    `;
                    list.appendChild(card);
                }
            });
        }

        // [ìµœì¢…] ëª¨ë‹¬ ì—´ê¸°
        function openModal(postId) {
            const post = window.allPosts.find(p => p.id === postId);
            if (!post) return;
            
            window.currentPostId = postId;
            const contentDiv = document.getElementById('modal-content');
            const repliesDiv = document.getElementById('modal-replies');
            
            // 1. ë³¸ë¬¸ ë Œë”ë§
            let mainImgHtml = '';
            if (post.image_url) {
                mainImgHtml = `<a href="${post.image_url}" target="_blank">
                    <img src="${post.image_url}" style="max-width:100%; margin-bottom:15px; border-radius:5px; border:1px solid #333;">
                </a>`;
            }
            let contentHtml = post.content.replace(/^>(.*)$/gm, '<span class="greentext">>$1</span>');

            contentDiv.innerHTML = `
                <h2 style="color:var(--accent); margin-top:0;">${post.subject || 'ë¬´ì œ'}</h2>
                <div style="color:#666; font-size:0.8rem; margin-bottom:15px;">No.${post.id} | ${post.name} | ${new Date(post.created_at).toLocaleString()}</div>
                ${mainImgHtml}
                <div style="white-space:pre-wrap; line-height:1.6; font-size:1rem; margin-bottom:30px;">${contentHtml}</div>
            `;

            // 2. ëŒ“ê¸€ ë Œë”ë§
            const replies = window.allPosts
                .filter(p => p.parent_id === postId)
                .sort((a,b) => new Date(a.created_at) - new Date(b.created_at));

            let repliesHtml = '<h4 style="margin:0 0 15px 0; color:#888; border-top:1px solid #333; padding-top:15px;">ëŒ“ê¸€</h4>';
            replies.forEach(reply => {
                let replyImg = reply.image_url ? `<br><a href="${reply.image_url}" target="_blank"><img src="${reply.image_url}" style="max-width:150px; margin-top:5px; border-radius:4px;"></a>` : '';
                repliesHtml += `
                    <div style="background:#222; padding:12px; margin-bottom:10px; border-radius:6px; border-left:3px solid #444;">
                        <div style="font-size:0.8rem; color:#666; margin-bottom:4px;">
                            <span style="color:var(--accent); font-weight:bold;">${reply.name}</span>
                            ${new Date(reply.created_at).toLocaleString()}
                        </div>
                        <div style="color:#ddd;">${reply.content} ${replyImg}</div>
                    </div>
                `;
            });
            repliesDiv.innerHTML = repliesHtml;

            // 3. ì‚­ì œ ë²„íŠ¼ì— ê¸°ëŠ¥ ì—°ê²° (ë¹„ë°€ë²ˆí˜¸ ì „ë‹¬)
            const deleteBtn = document.getElementById('modal-delete-btn');
            deleteBtn.onclick = () => deletePost(post.password);

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('post-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        async function deletePost(realPassword) {
            const inputPw = prompt("ê¸€ ì‘ì„± ì‹œ ì…ë ¥í–ˆë˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!inputPw) return;

            if (inputPw === realPassword) {
                const { error } = await client.from('board_posts').delete().eq('id', window.currentPostId);
                if (error) alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
                else {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                }
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
            }
        }

        function closeModal(e) {
            if (e.target.id === 'post-modal') {
                document.getElementById('post-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        async function submitPost() {
            const name = document.getElementById('input-name').value;
            const subject = document.getElementById('input-subject').value;
            const content = document.getElementById('input-comment').value;
            const password = document.getElementById('input-password').value;
            const fileInput = document.getElementById('input-file');

            if (!content && !fileInput.files.length) return alert("ë‚´ìš©ì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (!password) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

            let imageUrl = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2,9)}.${file.name.split('.').pop()}`;
                const { error } = await client.storage.from('board_images').upload(fileName, file);
                if (error) return alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
                imageUrl = client.storage.from('board_images').getPublicUrl(fileName).data.publicUrl;
            }

            const { error } = await client.from('board_posts').insert({
                name: name || 'Anonymous',
                subject: subject,
                content: content,
                password: password,
                image_url: imageUrl,
                parent_id: null
            });

            if (error) alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
            else location.reload();
        }

        async function submitReply() {
            const content = document.getElementById('reply-input').value;
            if(!content) return;
            
            const { error } = await client.from('board_posts').insert({
                parent_id: window.currentPostId,
                content: content,
                name: 'Anonymous',
                password: 'reply'
            });

            if(!error) {
                document.getElementById('reply-input').value = '';
                await loadPosts(); 
                openModal(window.currentPostId);
            } else {
                alert("ëŒ“ê¸€ ì‹¤íŒ¨");
            }
        }

        loadPosts();
    </script>
</body>
</html>