<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOCHAN - Anon Space</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* ğŸŒŒ [JindoStar ìš°ì£¼ í…Œë§ˆ ì‹œìŠ¤í…œ] */
        :root {
            --bg-deep: #050510;
            --accent: #00d4ff;       /* ë„¤ì˜¨ ì‹œì•ˆ (JindoFlix í†µì¼) */
            --accent-glow: rgba(0, 212, 255, 0.3);
            --glass-bg: rgba(20, 20, 35, 0.6); /* ë°˜íˆ¬ëª… ìœ ë¦¬ìƒ‰ */
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sub: #a4a4c5;
            --quote-color: #a6e22e;  /* ì¸ìš©êµ¬ (í•´ì»¤ ê·¸ë¦°) */
            --admin-color: #ff4f6d;  /* ê´€ë¦¬ì/ê°•ì¡° ìƒ‰ */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', monospace;
            background-color: var(--bg-deep);
            color: var(--text-main);
            /* ìš°ì£¼ ë³„ ë°°ê²½ (JindoFlixì™€ ë™ì¼) */
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            min-height: 100vh;
        }

        a { color: var(--text-sub); text-decoration: none; transition: 0.3s; }
        a:hover { color: var(--accent); text-shadow: 0 0 10px var(--accent); }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .top-bar {
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
            display: flex; gap: 15px;
            position: fixed; top: 0; width: 100%; z-index: 100;
        }
        .top-bar a.active { color: var(--accent); font-weight: bold; }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 900px;
            margin: 80px auto 40px auto; /* í—¤ë” ë†’ì´ë§Œí¼ ë„ì›€ */
            padding: 0 15px;
        }

        /* íƒ€ì´í‹€ ì„¹ì…˜ */
        .board-header { text-align: center; margin-bottom: 40px; }
        .board-title {
            font-size: 2.5rem; font-weight: 900; color: var(--accent);
            text-shadow: 0 0 20px var(--accent-glow);
            letter-spacing: 2px; margin: 0;
        }
        .board-subtitle { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }

        /* âœ¨ ê¸€ì“°ê¸° í¼ (ìœ ë¦¬ íŒ¨ë„ ìŠ¤íƒ€ì¼) */
        .post-form {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            margin-bottom: 50px;
            transition: 0.3s;
        }
        .post-form:focus-within { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }

        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; }
        
        /* ì¸í’‹ ìŠ¤íƒ€ì¼ (í„°ë¯¸ë„ ëŠë‚Œ) */
        input, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 4px;
            color: white;
            padding: 10px;
            font-family: 'Pretendard', monospace;
            font-size: 0.95rem;
            outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent); background: rgba(0, 212, 255, 0.05); }
        textarea { resize: vertical; height: 80px; }
        ::placeholder { color: #555; }

        /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì»¤ìŠ¤í…€ */
        input[type="file"] { padding: 5px; font-size: 0.8rem; }

        /* ì „ì†¡ ë²„íŠ¼ */
        .btn-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--accent), #0066ff);
            color: white; border: none; border-radius: 6px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            transition: 0.3s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent-glow); }

        /* ğŸ§µ ê²Œì‹œê¸€ ëª©ë¡ (ìŠ¤ë ˆë“œ) */
        .thread {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        /* ì‘ì„±ì í—¤ë” */
        .post-meta { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 10px; display: flex; gap: 10px; align-items: center;}
        .post-meta .name { color: var(--accent); font-weight: bold; }
        .post-meta .subject { color: #fff; font-weight: 700; font-size: 1rem; }
        .post-meta .id { font-family: monospace; color: #666; }
        .post-no { cursor: pointer; color: #fff; }
        .post-no:hover { color: var(--admin-color); }

        /* ë³¸ë¬¸ ë ˆì´ì•„ì›ƒ */
        .post-body { display: flex; gap: 20px; align-items: flex-start; }
        
        /* ì´ë¯¸ì§€ */
        .post-img-wrap { flex-shrink: 0; }
        .post-thumb {
            max-width: 200px; max-height: 200px;
            border-radius: 4px; border: 1px solid #333;
            cursor: pointer; transition: 0.3s;
        }
        .post-thumb:hover { border-color: var(--accent); }
        
        /* í…ìŠ¤íŠ¸ ë‚´ìš© */
        .post-text { 
            flex-grow: 1; white-space: pre-wrap; line-height: 1.6; color: #eee; font-size: 0.95rem; 
        }
        .greentext { color: var(--quote-color); } /* > ì¸ìš©êµ¬ ìƒ‰ìƒ */

        /* ğŸ’¬ ë‹µê¸€ (Reply) */
        .reply-box {
            margin-top: 15px;
            margin-left: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-left: 3px solid #333;
            border-radius: 0 6px 6px 0;
        }
        .reply-box:hover { border-left-color: var(--accent); background: rgba(255, 255, 255, 0.05); }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 600px) {
            .post-body { flex-direction: column; }
            .post-thumb { max-width: 150px; }
            .form-row { flex-direction: column; gap: 10px; }
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading { text-align: center; color: var(--accent); font-family: monospace; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

    </style>
</head>
<body>

    <nav class="top-bar">
        <a href="/">JINDOFLIX</a>
        <a href="/board.html" class="active">/b/ ìµëª…ì±„ë„</a>
        <a href="#" onclick="alert('ì¤€ë¹„ì¤‘')">/hack/ ì •ë³´</a>
    </nav>

    <div class="container">
        <div class="board-header">
            <h1 class="board-title">/BOARD/</h1>
            <div class="board-subtitle">Anonymous Communication Uplink established.</div>
        </div>

        <div class="post-form">
            <div class="form-row">
                <input type="text" id="input-name" placeholder="ë‹‰ë„¤ì„ (ë¹„ìš°ë©´ ìµëª…)" style="flex: 1;">
                <input type="password" id="input-password" placeholder="ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)" style="flex: 1;">
            </div>
            <div class="form-group" style="margin-top:10px;">
                <input type="text" id="input-subject" placeholder="ì œëª© (ì„ íƒì‚¬í•­)">
            </div>
            <div class="form-group">
                <textarea id="input-comment" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... ( > ë¡œ ì‹œì‘í•˜ë©´ ì´ˆë¡ìƒ‰ì´ ë©ë‹ˆë‹¤)"></textarea>
            </div>
            <div class="form-row" style="align-items: center;">
                <input type="file" id="input-file" style="flex: 2;">
                <button class="btn-submit" onclick="submitPost()">ì „ì†¡ (UPLOAD)</button>
            </div>
        </div>

        <div id="thread-list">
            <div class="loading">/// RECEIVING DATA FROM DEEP SPACE... ///</div>
        </div>
    </div>

    <script>
        // =================================================
        // [í•„ìˆ˜] ë³¸ì¸ì˜ Supabase í‚¤ë¡œ êµì²´í•˜ì„¸ìš”!
        // =================================================
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4'
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        // ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPosts() {
            const { data, error } = await client
                .from('board_posts')
                .select('*')
                .order('created_at', { ascending: false });

            const list = document.getElementById('thread-list');
            list.innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°

            if (error) {
                list.innerHTML = `<div style="text-align:center; color:red;">ì‹ í˜¸ ìˆ˜ì‹  ì‹¤íŒ¨: ${error.message}</div>`;
                return;
            }

            // ìŠ¤ë ˆë“œ(ì›ê¸€) ë Œë”ë§
            data.forEach(post => {
                if (post.parent_id === null) {
                    const thread = document.createElement('div');
                    thread.className = 'thread';
                    
                    // ì´ë¯¸ì§€
                    let imgHtml = '';
                    if (post.image_url) {
                        imgHtml = `
                            <div class="post-img-wrap">
                                <img src="${post.image_url}" class="post-thumb" onclick="toggleImage(this)">
                            </div>`;
                    }

                    // ë‚´ìš© (ê·¸ë¦°í…ìŠ¤íŠ¸ ì²˜ë¦¬)
                    let contentHtml = post.content
                        .replace(/</g, "&lt;") // XSS ë°©ì§€
                        .replace(/^>(.*)$/gm, '<span class="greentext">>$1</span>');

                    thread.innerHTML = `
                        <div class="post-meta">
                            <span class="subject">${post.subject || 'ë¬´ì œ'}</span>
                            <span class="name">${post.name || 'Anonymous'}</span>
                            <span class="id">${new Date(post.created_at).toLocaleString()}</span>
                            <span class="post-no" onclick="addReplyLink(${post.id})">No.${post.id}</span>
                            <a href="#" style="font-size:0.8rem;" onclick="addReplyLink(${post.id}); return false;">[ë‹µê¸€]</a>
                        </div>
                        <div class="post-body">
                            ${imgHtml}
                            <div class="post-text">${contentHtml}</div>
                        </div>
                        <div id="replies-${post.id}" style="margin-top:10px;"></div>
                    `;
                    list.appendChild(thread);
                }
            });

            // ëŒ“ê¸€(Reply) ë Œë”ë§
            data.forEach(post => {
                if (post.parent_id !== null) {
                    const parentDiv = document.getElementById(`replies-${post.parent_id}`);
                    if (parentDiv) {
                        const reply = document.createElement('div');
                        reply.className = 'reply-box';
                        
                        let imgHtml = post.image_url ? `<div style="margin-bottom:5px;"><a href="${post.image_url}" target="_blank" style="color:#00d4ff;">[ì´ë¯¸ì§€ ì²¨ë¶€]</a></div>` : '';
                        let contentHtml = post.content
                            .replace(/</g, "&lt;")
                            .replace(/^>(.*)$/gm, '<span class="greentext">>$1</span>');

                        reply.innerHTML = `
                            <div class="post-meta">
                                <span class="name">${post.name || 'Anonymous'}</span>
                                <span class="id">${new Date(post.created_at).toLocaleString()}</span>
                                <span class="post-no">No.${post.id}</span>
                            </div>
                            <div class="post-text">
                                ${imgHtml}
                                ${contentHtml}
                            </div>
                        `;
                        parentDiv.appendChild(reply);
                    }
                }
            });
        }

        // ê¸€ì“°ê¸°
        async function submitPost() {
            const name = document.getElementById('input-name').value;
            const subject = document.getElementById('input-subject').value;
            const content = document.getElementById('input-comment').value;
            const password = document.getElementById('input-password').value;
            const fileInput = document.getElementById('input-file');

            if (!content && !fileInput.files.length) {
                alert("ë‚´ìš©ì´ë‚˜ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }
            if (!password) {
                alert("ì‚­ì œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            let imageUrl = null;

            // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                
                const { data, error } = await client.storage
                    .from('board_images') // ë²„í‚· ì´ë¦„ í™•ì¸!
                    .upload(fileName, file);
                
                if (error) {
                    alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
                    return;
                }
                
                const { data: urlData } = client.storage.from('board_images').getPublicUrl(fileName);
                imageUrl = urlData.publicUrl;
            }

            // 2. DB ì €ì¥
            const { error } = await client
                .from('board_posts')
                .insert({
                    name: name || 'Anonymous',
                    subject: subject,
                    content: content,
                    password: password,
                    image_url: imageUrl,
                    parent_id: window.replyTargetId || null
                });

            if (error) {
                alert("ê¸€ì“°ê¸° ì‹¤íŒ¨: " + error.message);
            } else {
                location.reload();
            }
        }

        // ì´ë¯¸ì§€ í´ë¦­ì‹œ í™•ëŒ€/ì¶•ì†Œ
        function toggleImage(img) {
            if (img.style.maxWidth === '100%') {
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
            } else {
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
            }
        }

        // ë‹µê¸€ ëª¨ë“œ
        function addReplyLink(id) {
            window.replyTargetId = id;
            const textarea = document.getElementById('input-comment');
            textarea.value = `>>${id}\n` + textarea.value;
            textarea.focus();
            window.scrollTo(0,0);
            document.querySelector('.btn-submit').innerText = `No.${id}ì— ë‹µê¸€ ì‘ì„± ì¤‘...`;
        }

        loadPosts();
    </script>

</body>
</html>