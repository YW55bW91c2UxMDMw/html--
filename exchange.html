<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR DEX - Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
    /* ëª¨ë„¤ë¡œ í…Œë§ˆ */
    .xmr-box {
        background: #1a1a1a; border: 1px solid #f26822; /* ëª¨ë„¤ë¡œ ì˜¤ë Œì§€ */
        border-radius: 12px; padding: 20px; color: #fff; text-align: center;
        margin-top: 20px;
    }
    .xmr-title { color: #f26822; font-weight: 900; font-size: 1.5rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .qr-area { background: white; padding: 10px; display: inline-block; border-radius: 8px; margin: 15px 0; }
    .wallet-addr {
        background: #333; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem;
        word-break: break-all; color: #aaa; border: 1px solid #444; margin-bottom: 15px; cursor: pointer;
    }
    .wallet-addr:hover { color: white; border-color: #f26822; }
    .input-xmr { width: 100%; margin-bottom: 10px; background: #222; border: 1px solid #555; color: white; padding: 12px; border-radius: 5px; }
    .btn-xmr { width: 100%; background: #f26822; color: black; font-weight: bold; padding: 12px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-xmr:hover { background: white; }
</style>

<div class="xmr-box">
    <div class="xmr-title">
        <img src="https://cryptologos.cc/logos/monero-xmr-logo.png" width="30">
        MONERO DEPOSIT
    </div>
    <p style="color:#888; font-size:0.9rem;">ì¶”ì  ë¶ˆê°€ëŠ¥í•œ ìµëª… ìì‚° XMRë¡œ ì¶©ì „í•˜ì„¸ìš”.</p>
    
    <div class="qr-area">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=44AFFq5kSiGBoZ4NMDwYtN18obc8AemS33DBLWs3H7otXft3XjrpDtQGv7SqSsaBYBb98uNbr2VBBEt7f2wfn3RVGQBEP3A" alt="QR">
    </div>

    <div class="wallet-addr" onclick="navigator.clipboard.writeText(this.innerText); alert('ì£¼ì†Œ ë³µì‚¬ë¨!');">
        44AFFq5kSiGBoZ4NMDwYtN18obc8AemS33DBLWs3H7otXft3XjrpDtQGv7SqSsaBYBb98uNbr2VBBEt7f2wfn3RVGQBEP3A
    </div>

    <div style="text-align: left; margin-bottom: 5px; font-size: 0.9rem; color: #f26822;">
        1 XMR â‰ˆ <span id="xmr-price">Loading...</span> KRW
    </div>

    <input type="number" id="xmr-amount" class="input-xmr" placeholder="ë³´ë‚¸ ìˆ˜ëŸ‰ (ì˜ˆ: 0.5)">
    <input type="text" id="xmr-txid" class="input-xmr" placeholder="TXID (íŠ¸ëœì­ì…˜ í•´ì‹œ/í‚¤)">
    
    <button class="btn-xmr" onclick="requestDeposit()">ì…ê¸ˆ í™•ì¸ ìš”ì²­</button>
</div>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì„¸ ì¡°íšŒ
    window.addEventListener('load', async () => {
        const price = await getXMRPrice(); // wallet.jsì— ìˆëŠ” í•¨ìˆ˜
        document.getElementById('xmr-price').innerText = price.toLocaleString();
    });

    function requestDeposit() {
        const amt = document.getElementById('xmr-amount').value;
        const txid = document.getElementById('xmr-txid').value;
        submitXMRDeposit(amt, txid); // wallet.js í•¨ìˆ˜ í˜¸ì¶œ
    }
</script>
</head>
<body>

    <header>
        <div class="logo">
            ğŸ¦Š JINDOSTAR DEX <span style="font-size:0.7rem; color:var(--text-sub); border:1px solid #444; padding:2px 5px; border-radius:4px;">PRO</span>
        </div>
        <div class="market-summary">
            <div class="summary-item">
                <span>í˜„ì¬ê°€ (Last Price)</span>
                <strong id="header-price" class="price-up">Loading...</strong>
            </div>
            <div class="summary-item">
                <span>ì´ ë°œí–‰ëŸ‰ (Total Supply)</span>
                <strong id="header-supply">-</strong>
            </div>
            <div class="summary-item">
                <span>ì‹œê°€ì´ì•¡ (Market Cap)</span>
                <strong id="header-cap">-</strong>
            </div>
        </div>
        <a href="/" style="color:var(--text-sub); text-decoration:none; font-size:0.9rem;">ë‚˜ê°€ê¸° â†©</a>
    </header>

    <div class="main-layout">
        
        <div class="panel">
            <div class="chart-section">
                <div class="chart-header">JDS / KRW ì°¨íŠ¸</div>
                <div id="real-chart"></div>
            </div>
            
            <div class="history-section">
                <div class="history-header">ë‚´ ê±°ë˜ ë‚´ì—­ (My Orders)</div>
                <div class="history-content">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ì¢…ë¥˜</th>
                                <th>ê°€ê²© (KRW)</th>
                                <th>ìˆ˜ëŸ‰ (JDS)</th>
                                <th>ì´ì•¡ (KRW)</th>
                            </tr>
                        </thead>
                        <tbody id="my-history-list">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel orderbook-section">
            <div class="ob-header">
                <span>ê°€ê²© (KRW)</span>
                <span>ìˆ˜ëŸ‰ (JDS)</span>
            </div>
            <div class="ob-list" id="ob-asks" style="justify-content: flex-end; padding-bottom: 5px;"></div>
            
            <div class="current-price-box" id="ob-center-price">1,250</div>
            
            <div class="ob-list" id="ob-bids" style="padding-top: 5px;"></div>
        </div>

        <div class="panel trade-section">
            <div class="trade-tabs">
                <div class="tab active-buy" id="tab-buy" onclick="setMode('BUY')">ë§¤ìˆ˜</div>
                <div class="tab" id="tab-sell" onclick="setMode('SELL')">ë§¤ë„</div>
            </div>

            <div class="input-group">
                <div class="balance-info">
                    <span>ê°€ëŠ¥ ê¸ˆì•¡</span>
                    <span id="wallet-balance">0 KRW</span>
                </div>
                <label class="input-label">ê°€ê²© (Price)</label>
                <input type="text" class="trade-input" id="input-price" readonly value="ì‹œì¥ê°€ (Market)">
            </div>

            <div class="input-group">
                <label class="input-label">ìˆ˜ëŸ‰ (Amount)</label>
                <input type="number" class="trade-input" id="input-amount" placeholder="0">
                <span class="unit">JDS</span>
            </div>

            <div style="margin-top:auto;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                    <span style="color:var(--text-sub)">ì˜ˆìƒ ì²´ê²°ì•¡</span>
                    <strong style="color:white;"><span id="est-total">0</span> KRW</strong>
                </div>
                <button class="btn-order btn-buy" id="btn-submit" onclick="executeTrade()">ë§¤ìˆ˜ (Buy)</button>
            </div>
        </div>

    </div>

    <script>
        // â˜… Supabase ì„¤ì •
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4';
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentMode = 'BUY';
        let currentPrice = 1000;
        let myProfile = { money: 0, token: 0 };
        let chart;

        // 1. ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            const options = {
                series: [{ name: 'Price', data: [] }],
                chart: {
                    type: 'area', height: '100%', background: 'transparent',
                    animations: { enabled: false }, toolbar: { show: false }
                },
                stroke: { curve: 'straight', width: 2, colors: ['#00d4ff'] },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } },
                dataLabels: { enabled: false },
                xaxis: { 
                    type: 'datetime', 
                    labels: { style: { colors: '#848e9c' }, datetimeFormatter: { hour: 'HH:mm' } },
                    axisBorder: { show: false }, axisTicks: { show: false }
                },
                yaxis: { 
                    opposite: true, 
                    labels: { style: { colors: '#848e9c' }, formatter: (val) => Math.floor(val) } 
                },
                grid: { borderColor: '#2b3139', strokeDashArray: 4 },
                theme: { mode: 'dark' },
                tooltip: { theme: 'dark', x: { format: 'dd MMM HH:mm' } }
            };
            chart = new ApexCharts(document.querySelector("#real-chart"), options);
            chart.render();
        }

        // 2. ì „ì²´ ë°ì´í„° ë¡œë“œ
        async function loadData() {
            // (1) ì‹œì¥ í†µê³„ (ê°€ê²©, ë°œí–‰ëŸ‰)
            const { data: stats } = await client.rpc('get_market_stats');
            if (stats) {
                currentPrice = stats.market_price || 1000;
                updateHeader(stats);
                renderOrderBook(currentPrice); // ê°€ìƒ í˜¸ê°€ì°½ ìƒì„±
            }

            // (2) ì°¨íŠ¸ ë°ì´í„°
            const { data: logs } = await client.from('trade_logs')
                .select('created_at, price_per_token')
                .order('created_at', { ascending: true })
                .limit(100);

            if (logs) {
                const chartData = logs.map(log => ({
                    x: new Date(log.created_at).getTime(),
                    y: log.price_per_token
                }));
                // ë°ì´í„°ê°€ ë„ˆë¬´ ì ìœ¼ë©´ ì•ë¶€ë¶„ì— ë”ë¯¸ ë°ì´í„° ì¶”ê°€ (ê·¸ë˜í”„ ëª¨ì–‘ ì¡ê¸°ìš©)
                if(chartData.length < 2) {
                    chartData.unshift({ x: new Date().getTime() - 1000000, y: 1000 });
                }
                chart.updateSeries([{ data: chartData }]);
            }

            // (3) ë‚´ ìì‚° ë° ê±°ë˜ë‚´ì—­
            const { data: { user } } = await client.auth.getUser();
            if(user) {
                const { data: profile } = await client.from('profiles').select('*').eq('id', user.id).single();
                if(profile) {
                    myProfile = profile;
                    updateWalletUI();
                }
                loadMyHistory(user.id);
            }
        }

        // 3. UI ì—…ë°ì´íŠ¸: í—¤ë” ì •ë³´
        function updateHeader(stats) {
            document.getElementById('header-price').innerText = Math.round(stats.market_price).toLocaleString();
            document.getElementById('header-supply').innerText = Math.round(stats.total_tokens).toLocaleString() + ' JDS';
            const cap = (stats.total_tokens * stats.market_price) / 100000000; // ì–µ ë‹¨ìœ„
            document.getElementById('header-cap').innerText = cap.toFixed(2) + ' ì–µì›';
            
            document.getElementById('ob-center-price').innerText = Math.round(stats.market_price).toLocaleString();
            
            // ìƒ‰ìƒ ë³€ê²½
            const el = document.getElementById('header-price');
            el.className = stats.market_price >= 1000 ? 'price-up' : 'price-down';
        }

        // 4. ê°€ìƒ í˜¸ê°€ì°½ ìƒì„± (í•µì‹¬ ì‹œê°íš¨ê³¼)
        function renderOrderBook(price) {
            const asksEl = document.getElementById('ob-asks');
            const bidsEl = document.getElementById('ob-bids');
            asksEl.innerHTML = '';
            bidsEl.innerHTML = '';

            const center = Math.round(price);
            const gap = Math.max(1, Math.round(price * 0.005)); // 0.5% ê°„ê²©

            // ë§¤ë„ í˜¸ê°€ (ìœ„ìª½, ê°€ê²© ë†’ì€ ìˆœ -> ë‚®ì€ ìˆœ)
            for(let i=8; i>=1; i--) {
                const p = center + (i * gap);
                const amt = Math.floor(Math.random() * 500) + 10;
                const width = Math.min(100, amt / 5); 
                asksEl.innerHTML += `
                    <div class="ob-row">
                        <div class="ob-bg sell-bg" style="width:${width}%"></div>
                        <span class="ob-price" style="color:var(--down-color)">${p.toLocaleString()}</span>
                        <span class="ob-amount">${amt}</span>
                    </div>`;
            }

            // ë§¤ìˆ˜ í˜¸ê°€ (ì•„ë˜ìª½, ê°€ê²© ë‚®ì€ ìˆœ)
            for(let i=1; i<=8; i++) {
                const p = center - (i * gap);
                const amt = Math.floor(Math.random() * 500) + 10;
                const width = Math.min(100, amt / 5);
                bidsEl.innerHTML += `
                    <div class="ob-row">
                        <div class="ob-bg buy-bg" style="width:${width}%"></div>
                        <span class="ob-price" style="color:var(--up-color)">${p.toLocaleString()}</span>
                        <span class="ob-amount">${amt}</span>
                    </div>`;
            }
        }

        // 5. ë‚´ ê±°ë˜ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMyHistory(userId) {
            const { data: logs } = await client.from('trade_logs')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(20);

            const list = document.getElementById('my-history-list');
            list.innerHTML = '';

            if(logs) {
                logs.forEach(log => {
                    const date = new Date(log.created_at);
                    const timeStr = `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
                    const typeColor = log.type === 'BUY' ? 'var(--up-color)' : 'var(--down-color)';
                    
                    list.innerHTML += `
                        <tr>
                            <td>${timeStr}</td>
                            <td style="color:${typeColor}; font-weight:bold;">${log.type === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</td>
                            <td>${Math.round(log.price_per_token).toLocaleString()}</td>
                            <td>${log.token_amount.toLocaleString()}</td>
                            <td>${log.total_krw.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }
        }

        // 6. ì£¼ë¬¸ì°½ ë¡œì§
        function setMode(mode) {
            currentMode = mode;
            const btn = document.getElementById('btn-submit');
            
            document.getElementById('tab-buy').className = mode === 'BUY' ? 'tab active-buy' : 'tab';
            document.getElementById('tab-sell').className = mode === 'SELL' ? 'tab active-sell' : 'tab';
            
            btn.className = mode === 'BUY' ? 'btn-order btn-buy' : 'btn-order btn-sell';
            btn.innerText = mode === 'BUY' ? 'ë§¤ìˆ˜ (Buy)' : 'ë§¤ë„ (Sell)';
            
            updateWalletUI();
        }

        function updateWalletUI() {
            const balEl = document.getElementById('wallet-balance');
            if(currentMode === 'BUY') {
                balEl.innerText = `${myProfile.money.toLocaleString()} KRW`;
            } else {
                balEl.innerText = `${myProfile.token.toLocaleString()} JDS`;
            }
            calculateTotal();
        }

        document.getElementById('input-amount').addEventListener('input', calculateTotal);

        function calculateTotal() {
            const amt = document.getElementById('input-amount').value;
            const total = amt * currentPrice;
            document.getElementById('est-total').innerText = Math.round(total).toLocaleString();
        }

        // 7. ê±°ë˜ ì‹¤í–‰
        async function executeTrade() {
            const amount = parseInt(document.getElementById('input-amount').value);
            if (currentMode === 'BUY') {
                alert("â›” [ë§¤ìˆ˜ ì œí•œ]\ní˜„ì¬ í† í°ì€ 'JINDO GALAXY'ì—ì„œ ì±„êµ´ì´ë‚˜ í™˜ì „ì„ í†µí•´ì„œë§Œ íšë“ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(ìœ ë™ì„± ë³´í˜¸ ì •ì±…)");
                return;
            }
            if(!amount || amount <= 0) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "ì²´ê²° ì¤‘...";

            const { data, error } = await client.rpc('trade_token', {
                trade_type: currentMode,
                amount: amount
            });

            if(error) {
                alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + error.message);
            } else {
                // ì•Œë¦¼ ëŒ€ì‹  ë¶€ë“œëŸ¬ìš´ ì—…ë°ì´íŠ¸
                console.log("ì²´ê²° ì™„ë£Œ", data);
                document.getElementById('input-amount').value = '';
                loadData(); // ë°ì´í„° ê°±ì‹ 
            }
            btn.disabled = false;
            setMode(currentMode); // í…ìŠ¤íŠ¸ ë³µêµ¬
        }

        // ì‹¤ì‹œê°„ êµ¬ë… (ê°€ê²© ë³€ë™ ì‹œ ì¦‰ì‹œ ë°˜ì˜)
        client.channel('public:trade_logs')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'trade_logs' }, () => {
                loadData();
            })
            .subscribe();

        // ì‹œì‘
        initChart();
        loadData();

    </script>
</body>
</html>