<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR - Deep Space Network</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        /* ğŸŒŒ [Galaxy Interface Theme] */
        :root {
            --bg-deep: #050510;
            --accent: #00f2ff;
            --accent-warn: #ff0055;
            --glass-panel: rgba(20, 30, 50, 0.75);
            --glass-border: rgba(100, 200, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #8899ac;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; font-family: 'Pretendard', monospace;
            background-color: var(--bg-deep); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* ë°°ê²½ ë³„ */
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .stars::after {
            content: " "; position: absolute; top: 0; left: 0; width: 1px; height: 1px; background: transparent;
            box-shadow: 10vw 10vh #fff, 25vw 40vh #fff, 50vw 80vh #fff, 75vw 20vh #fff, 90vw 90vh #fff;
            animation: star-move 120s linear infinite;
        }
        @keyframes star-move { from { transform: translateY(0); } to { transform: translateY(-100vh); } }

        /* ê³µí†µ UI ì»´í¬ë„ŒíŠ¸ */
        button { cursor: pointer; font-family: inherit; }
        input, textarea {
            background: rgba(0,0,0,0.4); border: 1px solid #445566; color: white;
            border-radius: 8px; padding: 12px; width: 100%; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent); }
        
        .btn-primary {
            background: linear-gradient(135deg, #00c3ff, #006eff); border: none;
            color: white; font-weight: bold; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 110, 255, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .btn-danger {
            background: rgba(255, 0, 85, 0.2); border: 1px solid var(--accent-warn);
            color: var(--accent-warn); padding: 8px 15px; border-radius: 6px; font-size: 0.8rem;
        }
        .btn-danger:hover { background: var(--accent-warn); color: white; }

        /* 1. ë¡œë¹„ (ì±„ë„ ëª©ë¡) */
        #lobby-view { flex: 1; padding: 20px; overflow-y: auto; max-width: 800px; margin: 0 auto; width: 100%; }
        
        .header-box {
            text-align: center; margin-bottom: 30px; padding: 40px 20px;
            background: var(--glass-panel); border-radius: 20px; border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        .channel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .channel-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 12px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        }
        .channel-card:hover { background: rgba(255,255,255,0.07); border-color: var(--accent); }
        .channel-card h3 { margin: 0 0 10px 0; color: var(--accent); }
        .channel-card p { font-size: 0.9rem; color: var(--text-muted); margin: 0; line-height: 1.4; height: 40px; overflow: hidden; }
        .badge-private {
            position: absolute; top: 10px; right: 10px; font-size: 0.7rem; 
            background: #333; color: #aaa; padding: 2px 6px; border-radius: 4px;
        }

        /* 2. ëª¨ë‹¬ (ì±„ë„ ìƒì„±/ì…ì¥) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #111620; border: 1px solid var(--glass-border);
            width: 90%; max-width: 450px; padding: 30px; border-radius: 16px;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.1);
        }

        /* 3. ì±„íŒ…ë°© */
        #chat-view { display: none; flex-direction: column; height: 100vh; }
        
        .chat-header {
            padding: 15px 20px; background: rgba(10, 15, 25, 0.95); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-info h2 { margin: 0; font-size: 1.2rem; color: white; }
        .chat-info span { font-size: 0.8rem; color: var(--accent); }
        .notice-box {
            background: rgba(0, 242, 255, 0.05); border-bottom: 1px solid rgba(0, 242, 255, 0.1);
            padding: 10px 20px; font-size: 0.85rem; color: #ccddee;
        }

        #chat-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg-row { display: flex; flex-direction: column; max-width: 80%; }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        .msg-row.theirs { align-self: flex-start; align-items: flex-start; }
        
        .msg-bubble {
            padding: 10px 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; word-break: break-all;
            background: #223344; border: 1px solid rgba(255,255,255,0.05);
        }
        .msg-row.mine .msg-bubble { background: #006eff; color: white; border: none; }
        .msg-row.admin .msg-bubble { border: 1px solid var(--accent); color: var(--accent); background: rgba(0, 242, 255, 0.05); }

        .input-area { padding: 15px; background: #0a0f18; border-top: 1px solid #333; display: flex; gap: 10px; }

    </style>
</head>
<body>
    <div class="stars"></div>

    <div id="lobby-view">
        <div class="header-box">
            <h1 style="margin:0; font-size:2.5rem; color:white;">JINDO<span style="color:var(--accent)">NET</span></h1>
            <p style="color:#8899ac;">ìµëª…ì„±, ë³´ì•ˆ, ê·¸ë¦¬ê³  ììœ ë¥¼ ìœ„í•œ ê³µê°„</p>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn-primary" onclick="openModal('create')">ì±„ë„ ë§Œë“¤ê¸°</button>
                <button style="background:#334; color:white; border:1px solid #556; padding:12px; border-radius:8px;" onclick="openModal('join-private')">ë¹„ê³µê°œ ì ‘ì†</button>
            </div>
        </div>

        <h3 style="color:var(--text-muted); border-bottom:1px solid #333; padding-bottom:10px;">ê³µê°œ ì£¼íŒŒìˆ˜ ëª©ë¡</h3>
        <div id="public-channel-list" class="channel-grid">
            <div style="color:#555; padding:20px;">ì±„ë„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <div id="chat-view">
        <div class="chat-header">
            <div class="chat-info">
                <h2 id="room-title">Channel Name</h2>
                <span id="room-status">â— ì—°ê²°ë¨</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-danger" id="admin-btn" style="display:none;" onclick="deleteChannel()">ì±„ë„ í­íŒŒ</button>
                <button style="background:#333; border:none; color:white; padding:5px 15px; border-radius:4px;" onclick="exitRoom()">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
        <div id="room-notice" class="notice-box"></div>

        <div id="chat-list"></div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.keyCode==13) sendMessage()">
            <button class="btn-primary" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <div id="modal-create" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:var(--accent);">ìƒˆ ì±„ë„ ê°œì„¤</h2>
            <input type="text" id="new-name" placeholder="ì±„ë„ ì´ë¦„ (ì˜ë¬¸/ìˆ«ì ê¶Œì¥)" style="margin-bottom:10px;">
            <textarea id="new-desc" placeholder="ì±„ë„ ê·œì¹™ ë° ì„¤ëª… (ê³µì§€ì‚¬í•­)" rows="3" style="margin-bottom:10px;"></textarea>
            <input type="password" id="new-admin-code" placeholder="ë°©ì¥ ë¹„ë°€ë²ˆí˜¸ (ì±„ë„ ê´€ë¦¬ìš©)" style="margin-bottom:10px;">
            
            <label style="display:flex; align-items:center; gap:10px; margin-bottom:20px; cursor:pointer; color:#ccc;">
                <input type="checkbox" id="is-public" checked> 
                <span>ê³µê°œ ëª©ë¡ì— í‘œì‹œ (ì²´í¬ í•´ì œ ì‹œ ë¹„ê³µê°œ)</span>
            </label>

            <button class="btn-primary" style="width:100%;" onclick="createChannel()">ì±„ë„ ìƒì„±</button>
            <button style="width:100%; background:none; border:none; color:#666; margin-top:10px;" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="modal-join-private" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:#fff;">ë¹„ê³µê°œ ì±„ë„ ì ‘ì†</h2>
            <p style="font-size:0.8rem; color:#888;">ì´ˆëŒ€ë°›ì€ ì±„ë„ ì´ë¦„ê³¼ ì•”í˜¸í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="p-name" placeholder="ì±„ë„ ì´ë¦„" style="margin-bottom:10px;">
            <input type="password" id="p-key" placeholder="ì•”í˜¸í™” í‚¤" style="margin-bottom:20px;">
            <button class="btn-primary" style="width:100%;" onclick="joinPrivate()">ì ‘ì† ì‹œë„</button>
            <button style="width:100%; background:none; border:none; color:#666; margin-top:10px;" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="modal-nick" class="modal-overlay">
        <div class="modal-box">
            <h2>ì½”ë“œë„¤ì„ ì„¤ì •</h2>
            <input type="text" id="my-nick" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„">
            <button class="btn-primary" style="width:100%; margin-top:15px;" onclick="setNickname()">í™•ì¸</button>
        </div>
    </div>

    <script>
        // =================================================
        // [í•„ìˆ˜] ë³¸ì¸ì˜ Supabase í‚¤ë¡œ êµì²´
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4';
        // =================================================
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        let myNick = localStorage.getItem('jindo_nick') || "";
        let currentRoom = null;
        let currentKey = null;
        let currentAdminCode = null; // ë‚´ê°€ ë°©ì¥ì¼ ë•Œ ì €ì¥
        let subscription = null;

        // [ì´ˆê¸°í™”]
        window.onload = () => {
            if (!myNick) document.getElementById('modal-nick').style.display = 'flex';
            loadPublicChannels();
        };

        function setNickname() {
            const nick = document.getElementById('my-nick').value.trim();
            if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
            myNick = nick;
            localStorage.setItem('jindo_nick', nick);
            document.getElementById('modal-nick').style.display = 'none';
        }

        // [ê¸°ëŠ¥ 1] ê³µê°œ ì±„ë„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPublicChannels() {
            const listEl = document.getElementById('public-channel-list');
            const { data, error } = await client
                .from('channels')
                .select('*')
                .eq('is_public', true)
                .order('created_at', { ascending: false });

            if (error) return console.error(error);

            listEl.innerHTML = "";
            if (data.length === 0) listEl.innerHTML = "<p style='color:#555; padding:20px;'>ê°œì„¤ëœ ê³µê°œ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";

            data.forEach(ch => {
                const div = document.createElement('div');
                div.className = 'channel-card';
                div.innerHTML = `
                    <h3># ${ch.name}</h3>
                    <p>${ch.description || 'ê·œì¹™ ì—†ìŒ'}</p>
                `;
                // ê³µê°œ ì±„ë„ì€ 'ì±„ë„ëª…' ìì²´ê°€ ì•”í˜¸í‚¤ê°€ ë©ë‹ˆë‹¤. (í¸ì˜ì„±)
                div.onclick = () => enterRoom(ch.name, ch.name, ch.description);
                listEl.appendChild(div);
            });
        }

        // [ê¸°ëŠ¥ 2] ì±„ë„ ìƒì„±
        async function createChannel() {
            const name = document.getElementById('new-name').value.trim();
            const desc = document.getElementById('new-desc').value.trim();
            const code = document.getElementById('new-admin-code').value.trim();
            const isPublic = document.getElementById('is-public').checked;

            if (!name || !code) return alert("ì±„ë„ëª…ê³¼ ë°©ì¥ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

            const { error } = await client.from('channels').insert({
                name: name,
                description: desc,
                is_public: isPublic,
                admin_code: code
            });

            if (error) {
                if (error.code === '23505') alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì±„ë„ ì´ë¦„ì…ë‹ˆë‹¤.");
                else alert("ìƒì„± ì‹¤íŒ¨: " + error.message);
            } else {
                alert("ì±„ë„ì´ ê°œì„¤ë˜ì—ˆìŠµë‹ˆë‹¤!");
                closeModal();
                loadPublicChannels();
            }
        }

        // [ê¸°ëŠ¥ 3] ë°© ì…ì¥ (ê³µí†µ)
        async function enterRoom(roomName, key, desc) {
            currentRoom = roomName;
            currentKey = key;
            
            // UI ì „í™˜
            document.getElementById('lobby-view').style.display = 'none';
            document.getElementById('chat-view').style.display = 'flex';
            document.getElementById('room-title').innerText = "# " + roomName;
            document.getElementById('room-notice').innerText = "ğŸ“¢ " + (desc || "ë³„ë„ì˜ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");

            // ë°©ì¥ ê¶Œí•œ í™•ì¸ (ì„ì‹œë¡œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë‚˜ ì…ë ¥ê°’ ì²´í¬ ì•ˆí•¨, ì‚­ì œ ì‹œ ë¬¼ì–´ë´„)
            document.getElementById('admin-btn').style.display = 'block'; // ëˆ„ë¥´ë©´ ë¹„ë²ˆ ë¬¼ì–´ë´„

            loadMessages();
            subscribe();
        }

        // ë¹„ê³µê°œ ë°© ì…ì¥ ì‹œë„
        async function joinPrivate() {
            const name = document.getElementById('p-name').value.trim();
            const key = document.getElementById('p-key').value.trim();
            if(!name || !key) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

            // ì±„ë„ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ê·œì¹™ ê°€ì ¸ì˜¤ê¸° ìœ„í•´)
            const { data } = await client.from('channels').select('description').eq('name', name).single();
            
            if (!data) {
                if(!confirm("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±„ë„ì…ë‹ˆë‹¤. ì„ì‹œ ì±„ë„ë¡œ ì ‘ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê·œì¹™ ì—†ìŒ)")) return;
                enterRoom(name, key, "ì„ì‹œ ì£¼íŒŒìˆ˜ì…ë‹ˆë‹¤.");
            } else {
                enterRoom(name, key, data.description);
            }
            closeModal();
        }

        function exitRoom() {
            if(subscription) subscription.unsubscribe();
            currentRoom = null;
            document.getElementById('chat-view').style.display = 'none';
            document.getElementById('lobby-view').style.display = 'block';
            document.getElementById('chat-list').innerHTML = '';
            loadPublicChannels(); // ëª©ë¡ ê°±ì‹ 
        }

        // [ê¸°ëŠ¥ 4] ë©”ì‹œì§€ ë¡œë“œ ë° ì „ì†¡ (ì•”í˜¸í™” ì ìš©)
        async function loadMessages() {
            const { data } = await client
                .from('chat_messages')
                .select('*')
                .eq('room_name', currentRoom)
                .order('created_at', { ascending: true })
                .limit(50);
            
            if(data) data.forEach(renderMessage);
            scrollToBottom();
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if (!text) return;

            const encrypted = CryptoJS.AES.encrypt(text, currentKey).toString();

            await client.from('chat_messages').insert({
                room_name: currentRoom,
                nickname: myNick,
                content: encrypted
            });
            input.value = '';
        }

        function renderMessage(msg) {
            const list = document.getElementById('chat-list');
            const isMine = msg.nickname === myNick;
            let text = "";
            let isError = false;

            try {
                const bytes = CryptoJS.AES.decrypt(msg.content, currentKey);
                text = bytes.toString(CryptoJS.enc.Utf8);
                if(!text) throw new Error();
            } catch (e) {
                text = "ğŸ”’ í•´ë… ë¶ˆê°€ (ì˜ëª»ëœ í‚¤)";
                isError = true;
            }

            const div = document.createElement('div');
            div.className = isMine ? 'msg-row mine' : 'msg-row';
            div.innerHTML = `
                <div style="font-size:0.75rem; color:#667; margin:0 5px 2px 5px;">${msg.nickname}</div>
                <div class="msg-bubble" style="${isError ? 'color:#ff5555; border:1px dashed #553333; background:none;' : ''}">${text}</div>
            `;
            list.appendChild(div);
            scrollToBottom();
        }

        function subscribe() {
            subscription = client.channel(currentRoom)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages', filter: `room_name=eq.${currentRoom}` }, 
                payload => { renderMessage(payload.new); })
                .subscribe();
        }

        // [ê¸°ëŠ¥ 5] ë°©ì¥ ê¸°ëŠ¥ (ì±„ë„ ì‚­ì œ)
        async function deleteChannel() {
            const code = prompt("ì±„ë„ì„ ì‚­ì œí•˜ë ¤ë©´ ë°©ì¥ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!code) return;

            // 1. ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const { data, error } = await client
                .from('channels')
                .select('id')
                .eq('name', currentRoom)
                .eq('admin_code', code)
                .single();

            if (error || !data) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ëŒ€í™”ë‚´ìš©ì€ ìœ ì§€ë˜ì§€ë§Œ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;

            // 2. ì‚­ì œ (ì±„ë„ ì •ë³´ë§Œ ì‚­ì œ, ë¡œê·¸ëŠ” ë‚¨ê²¨ë‘ê±°ë‚˜ ê°™ì´ ì§€ìš¸ ìˆ˜ ìˆìŒ)
            await client.from('channels').delete().eq('id', data.id);
            alert("ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            exitRoom();
        }

        // UI í—¬í¼
        function scrollToBottom() { const l = document.getElementById('chat-list'); l.scrollTop = l.scrollHeight; }
        function openModal(id) { 
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display='none');
            if(id==='create') document.getElementById('modal-create').style.display='flex';
            if(id==='join-private') document.getElementById('modal-join-private').style.display='flex';
        }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(el => el.style.display='none'); }

    </script>
</body>
</html>