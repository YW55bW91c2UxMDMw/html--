<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDO GALAXY - Mining</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="wallet.js"></script> <style>
        /* ğŸŒŒ Deep Space Theme (ìœ ì§€) */
        :root {
            --bg-deep: #050510;
            --accent: #00d4ff;
            --glass-bg: rgba(20, 20, 35, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; font-family: 'Pretendard';
            background-color: var(--bg-deep); color: var(--text-main);
            background-image: url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2000&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: -1; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        .nav-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--glass-bg); border-radius: 15px; border: 1px solid var(--border); }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--accent); }
        .resources { display: flex; gap: 20px; font-size: 1.1rem; font-weight: bold; }
        .res-item span { color: #ffd700; }

        .mine-section {
            background: var(--glass-bg); border: 1px solid var(--accent);
            border-radius: 20px; padding: 40px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 500px; position: relative; overflow: hidden;
        }
        
        .mining-planet {
            width: 250px; height: 250px;
            background: radial-gradient(circle at 30% 30%, #4a90e2, #001f3f);
            border-radius: 50%; box-shadow: 0 0 50px rgba(74, 144, 226, 0.5);
            cursor: pointer; transition: 0.1s; position: relative; z-index: 10;
        }
        .mining-planet:active { transform: scale(0.95); }
        .mining-planet::after {
            content: 'â›ï¸ CLICK TO MINE'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: rgba(255,255,255,0.5); font-weight: bold; pointer-events: none;
        }

        .click-effect {
            position: absolute; color: #fff; font-weight: bold; font-size: 1.2rem;
            animation: floatUp 1s ease-out forwards; pointer-events: none;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        .market-section {
            background: var(--glass-bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px; display: flex; flex-direction: column;
        }
        .market-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        .planet-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); 
            gap: 15px; overflow-y: auto; max-height: 600px; padding-right: 5px;
        }
        
        .planet-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;
            display: flex; align-items: center; gap: 15px; transition: 0.3s; border: 1px solid transparent;
        }
        .planet-card:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        
        .p-icon { width: 50px; height: 50px; border-radius: 50%; background: #333; }
        .p-info { flex: 1; }
        .p-name { font-weight: bold; font-size: 1.1rem; color: var(--accent); }
        .p-stat { font-size: 0.8rem; color: #00ff9d; margin-top: 5px; }
        
        .p-btn {
            background: #ffd700; color: #000; border: none; padding: 8px 15px;
            border-radius: 5px; font-weight: bold; cursor: pointer;
        }
        .p-btn:disabled { background: #555; color: #aaa; cursor: not-allowed; }
        .p-btn.owned { background: var(--accent); color: white; }

        .exchange-ui {
            margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; width: 100%; text-align: center;
        }
        .btn-ex {
            background: linear-gradient(90deg, #00d4ff, #0055ff); color: white; border: none;
            padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="overlay"></div>

    <div class="container">
        <div class="nav-bar">
            <div class="logo">ğŸŒŒ JINDO GALAXY</div>
            <div class="resources">
                <div class="res-item">ğŸ’ Dust: <span id="ui-stardust">Loading...</span></div>
                <div class="res-item">ğŸª™ JDS: <span id="ui-token">Loading...</span></div>
            </div>
            <a href="/" style="color:white; text-decoration:none; font-weight:bold;">ë‚˜ê°€ê¸°</a>
        </div>

        <div class="mine-section">
            <h2 style="margin-bottom:30px;">ASTEROID MINING</h2>
            <div class="mining-planet" id="click-planet" onclick="mineClick(event)"></div>
            <div style="margin-top:30px; color:#aaa; font-size:0.9rem;">
                í–‰ì„±ì„ í´ë¦­í•˜ì—¬ <span style="color:#bf00ff;">Stardust</span>ë¥¼ ì±„êµ´í•˜ì„¸ìš”!<br>
                <b>Black Hole X-1</b> ë³´ìœ  ì‹œ í´ë¦­ë‹¹ ì±„êµ´ëŸ‰ 10ë°° ì¦ê°€.
            </div>
            <div class="exchange-ui">
                <div>ë³´ìœ í•œ Stardustë¥¼ JDS í† í°ìœ¼ë¡œ ë³€í™˜</div>
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">(100 Dust = 1 JDS)</div>
                <button class="btn-ex" onclick="convertResources()">ğŸ”„ ì „ë¶€ í™˜ì „í•˜ê¸°</button>
            </div>
        </div>

        <div class="market-section">
            <div class="market-header">PLANET MARKET (í–‰ì„± ì •ë³µ)</div>
            <div id="planet-list" class="planet-grid">
                <div style="text-align:center; padding:20px;">í–‰ì„± ë°ì´í„° ë¡œë”©ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        let myStardust = 0;
        let myToken = 0;
        let clickCount = 0;
        let hasBlackHole = false; // ë¸”ë™í™€ ë³´ìœ  ì—¬ë¶€

        // 1. ì´ˆê¸°í™” (wallet.js ë¡œë“œ í›„ ì‹¤í–‰)
        window.addEventListener('load', async () => {
            setTimeout(async () => {
                if(!window.client) return alert("wallet.js ë¡œë“œ ì‹¤íŒ¨");
                const { data: { user } } = await window.client.auth.getUser();
                if(!user) { alert("ë¡œê·¸ì¸ í•„ìš”"); location.href='/'; return; }

                loadMyResources();
                loadPlanets();
                setInterval(saveMiningData, 5000); // 5ì´ˆë§ˆë‹¤ ìë™ ì €ì¥
            }, 500);
        });

        // 2. ìì› ë¡œë“œ
        async function loadMyResources() {
            const { data: { user } } = await window.client.auth.getUser();
            const { data } = await window.client.from('profiles').select('stardust, token').eq('id', user.id).single();
            if(data) {
                myStardust = data.stardust;
                myToken = data.token;
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('ui-stardust').innerText = myStardust.toLocaleString();
            document.getElementById('ui-token').innerText = myToken.toLocaleString();
        }

        // 3. í´ë¦­ ì±„êµ´
        function mineClick(e) {
            // ê¸°ë³¸ 1~2ê°œ, ë¸”ë™í™€ ë³´ìœ  ì‹œ 10ê°œ (0.1 JDS ìƒë‹¹)
            let gain = Math.floor(Math.random() * 2) + 1;
            if (hasBlackHole) gain = 10;

            myStardust += gain;
            clickCount += gain;
            
            updateUI();
            showEffect(e.clientX, e.clientY, `+${gain}`);
            
            const planet = document.getElementById('click-planet');
            planet.style.transform = 'scale(0.95)';
            setTimeout(() => planet.style.transform = 'scale(1)', 100);
        }

        function showEffect(x, y, text) {
            const el = document.createElement('div');
            el.className = 'click-effect';
            el.style.left = x + 'px'; el.style.top = y + 'px'; el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // 4. ì €ì¥ (ì„œë²„ ë™ê¸°í™”)
        async function saveMiningData() {
            if(clickCount > 0) {
                const amount = clickCount;
                clickCount = 0;
                await window.client.rpc('update_stardust_rpc', { amount: amount });
            }
        }

        // 5. í–‰ì„± ëª©ë¡
        async function loadPlanets() {
            const { data: { user } } = await window.client.auth.getUser();
            const { data: planets } = await window.client.from('planets').select('*').order('price_jds', { ascending: true });
            const list = document.getElementById('planet-list');
            list.innerHTML = '';

            planets.forEach(p => {
                const isMine = p.owner_id === user.id;
                const isSold = p.owner_id !== null && !isMine;
                
                // ë¸”ë™í™€ ë³´ìœ  ì²´í¬
                if (p.name.includes('Black Hole') && isMine) hasBlackHole = true;

                let btnHtml = '';
                if(isMine) btnHtml = `<button class="p-btn owned" disabled>ë‚´ í–‰ì„± ğŸš©</button>`;
                else if(isSold) btnHtml = `<button class="p-btn" disabled>ì •ë³µë¨ ğŸ”’</button>`;
                else btnHtml = `<button class="p-btn" onclick="buyPlanet(${p.id})">ì •ë³µí•˜ê¸° (${p.price_jds} T)</button>`;

                const div = document.createElement('div');
                div.className = 'planet-card';
                div.innerHTML = `
                    <div class="p-icon" style="background:${stringToColor(p.name)}"></div>
                    <div class="p-info">
                        <div class="p-name">${p.name}</div>
                        <div class="p-stat">ì±„êµ´ íš¨ìœ¨ UP</div>
                    </div>
                    <div>${btnHtml}</div>
                `;
                list.appendChild(div);
            });
        }

        async function buyPlanet(id) {
            if(!confirm("ì´ í–‰ì„±ì„ ì •ë³µí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í† í°ì´ ì°¨ê°ë©ë‹ˆë‹¤.")) return;
            const { data, error } = await window.client.rpc('buy_planet', { planet_id: id });
            if(data === 'success') {
                alert("ğŸª ì •ë³µ ì™„ë£Œ! ì±„êµ´ íš¨ìœ¨ì´ ì¦ê°€í•©ë‹ˆë‹¤.");
                location.reload();
            } else {
                alert("êµ¬ë§¤ ì‹¤íŒ¨: " + (error ? error.message : data));
            }
        }

        async function convertResources() {
            if(myStardust < 100) return alert("ìµœì†Œ 100 Dustê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            const amount = Math.floor(myStardust / 100) * 100;
            if(!confirm(`${amount} Dustë¥¼ ${amount/100} JDSë¡œ êµí™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const { error } = await window.client.rpc('convert_stardust', { amount: amount });
            if(!error) {
                alert("í™˜ì „ ì™„ë£Œ!");
                location.reload();
            } else {
                alert("ì˜¤ë¥˜: " + error.message);
            }
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${hash % 360}, 70%, 50%)`;
        }
    </script>
</body>
</html>