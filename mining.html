<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDO GALAXY - Mining & Conquest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ğŸŒŒ Deep Space Theme */
        :root {
            --bg-deep: #050510;
            --accent: #00d4ff;
            --rare: #bf00ff; /* í¬ê·€ ì•„ì´í…œ ë³´ë¼ìƒ‰ */
            --glass-bg: rgba(20, 20, 35, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; font-family: 'Pretendard';
            background-color: var(--bg-deep); color: var(--text-main);
            background-image: url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2000&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: -1; }

        /* ë ˆì´ì•„ì›ƒ */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        /* ìƒë‹¨ ë°” */
        .nav-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--glass-bg); border-radius: 15px; border: 1px solid var(--border); }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--accent); }
        .resources { display: flex; gap: 20px; font-size: 1.1rem; font-weight: bold; }
        .res-item span { color: #ffd700; }

        /* ì¢Œì¸¡: ì±„êµ´ì¥ */
        .mine-section {
            background: var(--glass-bg); border: 1px solid var(--accent);
            border-radius: 20px; padding: 40px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 500px; position: relative; overflow: hidden;
        }
        
        /* ì±„êµ´ìš© í–‰ì„± (í´ë¦­ íƒ€ê²Ÿ) */
        .mining-planet {
            width: 250px; height: 250px;
            background: radial-gradient(circle at 30% 30%, #4a90e2, #001f3f);
            border-radius: 50%; box-shadow: 0 0 50px rgba(74, 144, 226, 0.5);
            cursor: pointer; transition: 0.1s; position: relative; z-index: 10;
        }
        .mining-planet:active { transform: scale(0.95); }
        .mining-planet::after {
            content: 'â›ï¸ CLICK TO MINE'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: rgba(255,255,255,0.5); font-weight: bold; pointer-events: none;
        }

        /* í´ë¦­ ì´í™íŠ¸ */
        .click-effect {
            position: absolute; color: #fff; font-weight: bold; font-size: 1.2rem;
            animation: floatUp 1s ease-out forwards; pointer-events: none;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* ìš°ì¸¡: í–‰ì„± ë§ˆì¼“ */
        .market-section {
            background: var(--glass-bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px; display: flex; flex-direction: column;
        }
        .market-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        .planet-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); 
            gap: 15px; overflow-y: auto; max-height: 600px; padding-right: 5px;
        }
        
        .planet-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;
            display: flex; align-items: center; gap: 15px; transition: 0.3s; border: 1px solid transparent;
        }
        .planet-card:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        
        .p-icon { width: 50px; height: 50px; border-radius: 50%; background: #333; }
        .p-info { flex: 1; }
        .p-name { font-weight: bold; font-size: 1.1rem; color: var(--accent); }
        .p-desc { font-size: 0.8rem; color: #aaa; }
        .p-stat { font-size: 0.8rem; color: #00ff9d; margin-top: 5px; }
        
        .p-btn {
            background: #ffd700; color: #000; border: none; padding: 8px 15px;
            border-radius: 5px; font-weight: bold; cursor: pointer;
        }
        .p-btn:disabled { background: #555; color: #aaa; cursor: not-allowed; }
        .p-btn.owned { background: var(--accent); color: white; }

        /* í™˜ì „ì†Œ UI */
        .exchange-ui {
            margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; width: 100%; text-align: center;
        }
        .btn-ex {
            background: linear-gradient(90deg, #00d4ff, #0055ff); color: white; border: none;
            padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="overlay"></div>

    <div class="container">
        <div class="nav-bar">
            <div class="logo">ğŸŒŒ JINDO GALAXY</div>
            <div class="resources">
                <div class="res-item">ğŸ’ Stardust: <span id="ui-stardust">0</span></div>
                <div class="res-item">ğŸª™ Token: <span id="ui-token">0</span></div>
            </div>
            <a href="/" style="color:white; text-decoration:none; font-weight:bold;">ë‚˜ê°€ê¸°</a>
        </div>

        <div class="mine-section">
            <h2 style="margin-bottom:30px;">ASTEROID MINING</h2>
            
            <div class="mining-planet" id="click-planet" onclick="mineClick(event)"></div>
            
            <div style="margin-top:30px; color:#aaa; font-size:0.9rem;">
                í–‰ì„±ì„ í´ë¦­í•˜ì—¬ ìŠ¤íƒ€ë”ìŠ¤íŠ¸(Stardust)ë¥¼ ì±„êµ´í•˜ì„¸ìš”!<br>
                ì •ë³µí•œ í–‰ì„±ì´ ë§ì„ìˆ˜ë¡ ìë™ ì±„êµ´ëŸ‰ì´ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.
            </div>

            <div class="exchange-ui">
                <div>ë³´ìœ í•œ ìŠ¤íƒ€ë”ìŠ¤íŠ¸ë¥¼ í† í°ìœ¼ë¡œ ë³€í™˜</div>
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">(í™˜ìœ¨: 100 Stardust = 1 JDS)</div>
                <button class="btn-ex" onclick="convertResources()">ğŸ”„ ì „ë¶€ í™˜ì „í•˜ê¸°</button>
            </div>
        </div>

        <div class="market-section">
            <div class="market-header">PLANET MARKET (í–‰ì„± ì •ë³µ)</div>
            <div id="planet-list" class="planet-grid">
                <div style="text-align:center; padding:20px;">í–‰ì„± ë°ì´í„° ë¡œë”©ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        // â˜… Supabase ì„¤ì •
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4';
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        let myStardust = 0;
        let myToken = 0;
        let myId = null;
        let clickCount = 0; // ì €ì¥ ìµœì í™”ìš©

        // 1. ì´ˆê¸°í™”
        window.onload = async () => {
            const { data: { user } } = await client.auth.getUser();
            if(!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='/'; return; }
            myId = user.id;

            loadMyResources();
            loadPlanets();
            
            // 5ì´ˆë§ˆë‹¤ ì±„êµ´ ë°ì´í„° ìë™ ì €ì¥ (ì„œë²„ ë¶€í•˜ ë°©ì§€)
            setInterval(saveMiningData, 5000);
        };

        // 2. ë‚´ ìì› ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMyResources() {
            const { data } = await client.from('profiles').select('stardust, token').eq('id', myId).single();
            if(data) {
                myStardust = data.stardust;
                myToken = data.token;
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('ui-stardust').innerText = myStardust.toLocaleString();
            document.getElementById('ui-token').innerText = myToken.toLocaleString();
        }

        // 3. í´ë¦­ ì±„êµ´ (í”„ë¡ íŠ¸ì—”ë“œ ì²˜ë¦¬)
        function mineClick(e) {
            // í´ë¦­ë‹¹ 1~3ê°œ ëœë¤
            const gain = Math.floor(Math.random() * 3) + 1;
            myStardust += gain;
            clickCount += gain; // ì„œë²„ì— ë³´ë‚¼ ëˆ„ì ì¹˜
            
            updateUI();
            showEffect(e.clientX, e.clientY, `+${gain}`);
            
            // ì‹œê° íš¨ê³¼
            const planet = document.getElementById('click-planet');
            planet.style.transform = 'scale(0.95)';
            setTimeout(() => planet.style.transform = 'scale(1)', 100);
        }

        // í´ë¦­ ì´í™íŠ¸ í‘œì‹œ
        function showEffect(x, y, text) {
            const el = document.createElement('div');
            el.className = 'click-effect';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // 4. ì±„êµ´ ë°ì´í„° ì„œë²„ ì €ì¥ (ì£¼ê¸°ì  ì‹¤í–‰)
        async function saveMiningData() {
            if(clickCount > 0) {
                const amount = clickCount;
                clickCount = 0; // ì´ˆê¸°í™”
                // RPC ì—†ì´ ì§ì ‘ ì—…ë°ì´íŠ¸ (ê°„ë‹¨ êµ¬í˜„)
                // ì‹¤ì œë¡œëŠ” ë³´ì•ˆì„ ìœ„í•´ RPC ì‚¬ìš© ê¶Œì¥ (update_stardust ë“±)
                // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ update_money ë“±ì„ ì‘ìš©í•˜ê±°ë‚˜ ì§ì ‘ SQL ì‹¤í–‰ í•„ìš”
                // ì„ì‹œë¡œ: í˜„ì¬ ê°’ì„ ì½ê³  ë”í•´ì„œ ì“°ëŠ” ë°©ì‹ì€ ë™ì‹œì„± ë¬¸ì œê°€ ìˆìœ¼ë¯€ë¡œ RPC í˜¸ì¶œì´ ë§ìŒ.
                // í¸ì˜ìƒ ë¡œì»¬ê°’ì€ ë¯¿ê³ , ë¡œì»¬ì—ì„œ ì¦ê°€ë¶„ë§Œ DBì— ë”í•´ì£¼ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í•¨.
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í”„ë¡œí•„ ì—…ë°ì´íŠ¸
                const { error } = await client.rpc('update_stardust_rpc', { amount: amount }); 
                // *ì£¼ì˜: Supabase SQLì— update_stardust_rpc í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì•¼ í•¨ (ì•„ë˜ ì°¸ê³ )
            }
        }

        // 5. í–‰ì„± ëª©ë¡ ë¡œë“œ
        async function loadPlanets() {
            const { data: planets } = await client.from('planets').select('*').order('price_jds', { ascending: true });
            const list = document.getElementById('planet-list');
            list.innerHTML = '';

            planets.forEach(p => {
                const isMine = p.owner_id === myId;
                const isSold = p.owner_id !== null && !isMine;
                
                let btnHtml = '';
                if(isMine) {
                    btnHtml = `<button class="p-btn owned" disabled>ë‚´ í–‰ì„± ğŸš©</button>`;
                } else if(isSold) {
                    btnHtml = `<button class="p-btn" disabled>ì •ë³µë¨ ğŸ”’</button>`;
                } else {
                    btnHtml = `<button class="p-btn" onclick="buyPlanet(${p.id})">ì •ë³µí•˜ê¸° (${p.price_jds} T)</button>`;
                }

                // ëœë¤ ìƒ‰ìƒ ì•„ì´ì½˜
                const color = `hsl(${Math.random()*360}, 70%, 50%)`;

                const card = document.createElement('div');
                card.className = 'planet-card';
                card.innerHTML = `
                    <div class="p-icon" style="background:${color}; box-shadow:0 0 10px ${color};"></div>
                    <div class="p-info">
                        <div class="p-name">${p.name}</div>
                        <div class="p-desc">${p.description}</div>
                        <div class="p-stat">âš¡ ìë™ ì±„êµ´: ${p.mining_rate} dust/sec</div>
                    </div>
                    <div>${btnHtml}</div>
                `;
                list.appendChild(card);
            });
        }

        // 6. í–‰ì„± êµ¬ë§¤
        async function buyPlanet(id) {
            if(!confirm("ì´ í–‰ì„±ì„ ì •ë³µí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í† í°ì´ ì°¨ê°ë©ë‹ˆë‹¤.")) return;

            const { data, error } = await client.rpc('buy_planet', { planet_id: id });
            
            if(error) {
                alert("êµ¬ë§¤ ì˜¤ë¥˜: " + error.message);
            } else if (data === 'success') {
                alert("ğŸª í–‰ì„± ì •ë³µ ì™„ë£Œ! ì´ì œ ìë™ ì±„êµ´ì´ ì‹œì‘ë©ë‹ˆë‹¤.");
                loadMyResources();
                loadPlanets();
            } else {
                alert("êµ¬ë§¤ ì‹¤íŒ¨: " + data);
            }
        }

        // 7. ìì› í™˜ì „ (Stardust -> Token)
        async function convertResources() {
            if(myStardust < 100) return alert("ìµœì†Œ 100 ìŠ¤íƒ€ë”ìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            
            const amount = Math.floor(myStardust / 100) * 100; // 100ë‹¨ìœ„ ëŠê¸°
            const confirmMsg = `${amount} ìŠ¤íƒ€ë”ìŠ¤íŠ¸ë¥¼ ${amount/100} í† í°ìœ¼ë¡œ êµí™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if(!confirm(confirmMsg)) return;

            const { error } = await client.rpc('convert_stardust', { amount: amount });
            
            if(error) {
                alert("í™˜ì „ ì‹¤íŒ¨: " + error.message);
            } else {
                alert("í™˜ì „ ì™„ë£Œ!");
                myStardust -= amount; // ì¦‰ì‹œ ë°˜ì˜
                myToken += (amount/100);
                updateUI();
            }
        }
        
        // â˜… ìë™ ì±„êµ´ ë¡œì§ (í´ë¼ì´ì–¸íŠ¸ ì‹œë®¬ë ˆì´ì…˜ + ì„œë²„ ë™ê¸°í™” í•„ìš”)
        // ì‹¤ì œë¡œëŠ” ì„œë²„(Edge Functions)ì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ì§€ê¸‰í•´ì•¼ í•˜ì§€ë§Œ, 
        // ê°„ë‹¨í•˜ê²Œ ìœ ì €ê°€ ì ‘ì†í•´ ìˆì„ ë•Œ ì‹œê°„ì°¨ë§Œí¼ ë³´ìƒí•˜ëŠ” ë°©ì‹ì´ ì¢‹ìŒ. (êµ¬í˜„ ìƒëµ)

    </script>
</body>
</html>