<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>RUMI: Hive Mind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* â˜£ï¸ [HACKER / HIVE THEME] */
        :root {
            --bg: #0a0a10;
            --primary: #00ffcc; /* ë¯¼íŠ¸ìƒ‰ (í•´ì»¤ ëŠë‚Œ) */
            --secondary: #ff00ff; /* ë§ˆì  íƒ€ */
            --panel-bg: rgba(0, 20, 20, 0.8);
            --border: rgba(0, 255, 204, 0.3);
        }

        body {
            background: var(--bg); color: var(--primary);
            font-family: 'Courier New', monospace;
            margin: 0; padding: 0; min-height: 100vh;
            overflow-x: hidden;
            transition: 0.5s;
        }

        /* ê²©ìë¬´ëŠ¬ ë°°ê²½ */
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.1; z-index: -1;
        }

        .container {
            max-width: 700px; margin: 0 auto; padding: 20px;
            text-align: center; position: relative; z-index: 10;
        }

        h1 { 
            text-transform: uppercase; letter-spacing: 3px; 
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        /* ğŸ¦  ë£¨ë¯¸ ì¼€ì´ì§€ */
        .pet-cage {
            width: 200px; height: 200px; margin: 20px auto;
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, rgba(0,255,204,0.1) 0%, #000 70%);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            transition: 0.3s;
            position: relative;
        }

        .rumi-visual { font-size: 5rem; filter: drop-shadow(0 0 10px var(--primary)); user-select: none; transition:0.2s;}

        /* UI ìš”ì†Œ */
        .stats-panel {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            background: var(--panel-bg); border: 1px solid var(--border);
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            font-size: 0.9rem; text-align: left;
        }

        .bar-container { width: 100%; background: #222; height: 8px; margin-top: 5px; border-radius: 4px; overflow:hidden; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button {
            background: rgba(0,0,0,0.5); color: var(--primary); 
            border: 1px solid var(--primary); padding: 15px; 
            font-family: inherit; font-weight: bold; cursor: pointer;
            text-transform: uppercase; transition: 0.2s; border-radius: 4px;
        }
        button:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        button:active { transform: scale(0.95); }

        .btn-spread { color: var(--secondary); border-color: var(--secondary); }
        .btn-spread:hover { background: var(--secondary); color: white; box-shadow: 0 0 15px var(--secondary); }

        /* ğŸ† ë­í‚¹ ë³´ë“œ (Lv.4 ì „ìš©) */
        #leaderboard-section {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            background: rgba(0,0,0,0.8); border: 1px solid var(--secondary);
            padding: 20px; border-radius: 8px; margin-top: 20px;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.2);
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

        .rank-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top:10px; }
        .rank-table th { text-align: left; color: #aaa; border-bottom: 1px solid #555; padding: 5px; }
        .rank-table td { padding: 8px 5px; border-bottom: 1px solid #222; }
        .rank-row:nth-child(1) { color: gold; font-weight: bold; } /* 1ë“± */
        .rank-row:nth-child(2) { color: silver; } /* 2ë“± */
        .rank-row:nth-child(3) { color: #cd7f32; } /* 3ë“± */

        /* --- ë‹¨ê³„ë³„ íš¨ê³¼ --- */
        .stage-4 .pet-cage { border-color: var(--secondary); animation: pulse 2s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 10px var(--secondary);} 50% {box-shadow: 0 0 30px var(--secondary);} 100% {box-shadow: 0 0 10px var(--secondary);} }

    </style>
</head>
<body>

    <div class="container">
        <h1>RUMI NETWORK</h1>
        <div style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">
            NODE STATUS: <span id="status-text">CONNECTING...</span>
        </div>

        <div class="pet-cage">
            <div class="rumi-visual" id="rumi-face">ğŸ¥š</div>
        </div>

        <div class="stats-panel">
            <div>ğŸ‘¤ NODE ID: <span id="host-name" style="color:white;">-</span></div>
            <div>ğŸ§¬ STAGE: <span id="level-name">Loading...</span></div>
            
            <div style="grid-column: span 2; margin-top:10px;">
                DATA MINED (EXP): <span id="exp-val">0</span>
                <div class="bar-container"><div class="bar-fill" id="exp-bar"></div></div>
            </div>
            
            <div style="grid-column: span 2; margin-top:5px; color:var(--secondary);">
                â˜£ï¸ INFECTED SYSTEMS: <span id="infect-val">0</span>
            </div>
        </div>

        <div class="btn-group">
            <button id="action-btn" onclick="feedRumi()">ğŸ’¾ MINE DATA</button>
            <button class="btn-spread" onclick="spreadVirus()">ğŸ”— SPREAD VIRUS</button>
        </div>

        <div id="leaderboard-section">
            <h3 style="margin:0; color:var(--secondary);">ğŸ† GLOBAL HACKER RANKING</h3>
            <p style="font-size:0.8rem; color:#aaa;">Top Infectors in the JindoStar Universe</p>
            
            <table class="rank-table">
                <thead>
                    <tr>
                        <th width="10%">#</th>
                        <th width="40%">HACKER</th>
                        <th width="25%">INFECTED</th>
                        <th width="25%">DATA(EXP)</th>
                    </tr>
                </thead>
                <tbody id="rank-list">
                    </tbody>
            </table>
            <button style="width:100%; margin-top:10px; font-size:0.8rem; padding:8px;" onclick="loadLeaderboard()">ğŸ”„ REFRESH RANKING</button>
        </div>

        <div id="console-log" style="text-align:left; font-size:0.75rem; color:#555; height:80px; overflow-y:auto; border-top:1px solid #333; padding-top:5px;">
            > Connecting to Hive Mind...
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4'
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        let myId = localStorage.getItem('rumi_virus_id');
        let virusData = null;

        const STAGE_INFO = {
            1: { name: "LV.1 Egg", maxExp: 30, icon: "ğŸ¥š", msg: "Dormant" },
            2: { name: "LV.2 Larva", maxExp: 80, icon: "ğŸ›", msg: "Waking Up" },
            3: { name: "LV.3 Pupa", maxExp: 200, icon: "ğŸ§¬", msg: "Mutating..." },
            4: { name: "LV.4 MASTER", maxExp: 999999, icon: "ğŸ‘‘ğŸ¦Š", msg: "RULER OF THE NET" }
        };

        window.onload = async () => {
            // 1. ì „ì—¼ ë¡œì§
            const params = new URLSearchParams(window.location.search);
            const hostId = params.get('host');

            if (hostId && hostId !== myId) {
                // RPC ì—†ì´ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
                const { data: host } = await client.from('rumi_virus').select('infection_count, exp').eq('id', hostId).single();
                if(host) {
                    await client.from('rumi_virus').update({ 
                        infection_count: host.infection_count + 1,
                        exp: host.exp + 50 // ì „ì—¼ì‹œ ëŒ€ëŸ‰ì˜ ê²½í—˜ì¹˜
                    }).eq('id', hostId);
                    log(`âš ï¸ Connected to Host Node: ${hostId.substring(0,4)}...`);
                }
            }

            // 2. ë‚´ ë°ì´í„° ë¡œë“œ
            if (!myId) {
                const nick = prompt("INITIATE: Enter Hacker Codename:", "Guest" + Math.floor(Math.random()*1000));
                const { data } = await client.from('rumi_virus').insert({ host_name: nick || 'Anon' }).select().single();
                myId = data.id;
                localStorage.setItem('rumi_virus_id', myId);
                virusData = data;
            } else {
                const { data } = await client.from('rumi_virus').select('*').eq('id', myId).single();
                virusData = data;
            }

            if(!virusData) { localStorage.removeItem('rumi_virus_id'); window.location.reload(); return; }

            render();
        };

        async function feedRumi() {
            if(!virusData) return;

            // Lv.4ì—ì„œëŠ” í´ë¦­ë‹¹ ì ìˆ˜ê°€ ë” ë§ì´ ì˜¤ë¦„ (ë¯¸ë‹ˆê²Œì„ íš¨ê³¼)
            let bonus = (virusData.level === 4) ? Math.floor(Math.random() * 10) + 5 : Math.floor(Math.random() * 3) + 1;
            virusData.exp += bonus;

            // ë ˆë²¨ì—… ì²´í¬ (Lv.4 ë¯¸ë§Œë§Œ)
            if (virusData.level < 4 && virusData.exp >= STAGE_INFO[virusData.level].maxExp) {
                virusData.level++;
                virusData.exp = 0;
                alert("âš ï¸ SYSTEM UPGRADE! Level Up!");
            }

            await client.from('rumi_virus').update({ exp: virusData.exp, level: virusData.level }).eq('id', myId);
            
            render();
            
            // í´ë¦­ ì´í™íŠ¸
            const icon = document.getElementById('rumi-face');
            icon.style.transform = "scale(0.9)";
            setTimeout(() => icon.style.transform = "scale(1)", 100);
        }

        function spreadVirus() {
            const link = `${window.location.origin}${window.location.pathname}?host=${myId}`;
            navigator.clipboard.writeText(link).then(() => alert("ğŸ”— VIRUS LINK COPIED!\nSpread this link to increase your INFECTION RANK!"));
        }

        // í™”ë©´ ê·¸ë¦¬ê¸°
        function render() {
            const info = STAGE_INFO[virusData.level];
            document.getElementById('host-name').innerText = virusData.host_name;
            document.getElementById('level-name').innerText = info.name;
            document.getElementById('status-text').innerText = info.msg;
            document.getElementById('rumi-face').innerText = info.icon;
            document.getElementById('infect-val').innerText = virusData.infection_count;
            document.getElementById('exp-val').innerText = virusData.exp;

            // ê²½í—˜ì¹˜ ë°”
            let max = (virusData.level === 4) ? 5000 : info.maxExp; // ë§Œë ™ì€ ë°”ê°€ ì²œì²œíˆ ì°¸
            let pct = Math.min(100, (virusData.exp / max) * 100);
            document.getElementById('exp-bar').style.width = pct + "%";

            // Lv.4 ë„ë‹¬ ì‹œ ë­í‚¹íŒ ê³µê°œ
            if (virusData.level === 4) {
                document.body.classList.add('stage-4');
                document.getElementById('leaderboard-section').style.display = 'block';
                document.getElementById('action-btn').innerText = "â›ï¸ HACK & MINE"; // ë²„íŠ¼ ì´ë¦„ ë³€ê²½
                loadLeaderboard(); // ë­í‚¹ ë¡œë“œ
            }
        }

        // ğŸ† ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì—¼ ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
        async function loadLeaderboard() {
            const { data } = await client
                .from('rumi_virus')
                .select('host_name, infection_count, exp')
                .order('infection_count', { ascending: false }) // 1ìˆœìœ„: ì „ì—¼ ìˆ˜
                .order('exp', { ascending: false })             // 2ìˆœìœ„: ì±„êµ´ëŸ‰
                .limit(10);

            const list = document.getElementById('rank-list');
            list.innerHTML = '';

            if(data) {
                data.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.className = 'rank-row';
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.host_name}</td>
                        <td style="color:var(--secondary); font-weight:bold;">${user.infection_count}</td>
                        <td>${user.exp}</td>
                    `;
                    list.appendChild(row);
                });
            }
        }

        function log(msg) {
            const box = document.getElementById('console-log');
            box.innerHTML = `> ${msg}<br>` + box.innerHTML;
        }
    </script>
</body>
</html>