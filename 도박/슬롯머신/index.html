<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë£¨ë¯¸ ìŠ¬ë¡¯ë¨¸ì‹ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../wallet.js"></script>

    <style>
        /* ğŸ® Pygame ìŠ¤íƒ€ì¼ ë ˆì´ì•„ì›ƒ */
        body {
            margin: 0; padding: 0;
            background-color: #111;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: 'Pretendard', sans-serif;
            color: white; overflow: hidden;
        }

        /* ê²Œì„ í™”ë©´ í”„ë ˆì„ (800x600 ë¹„ìœ¨ ìœ ì§€) */
        .game-frame {
            width: 800px; height: 600px;
            position: relative;
            background-color: #000;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            /* ë°°ê²½ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì„¤ì •, ì—†ìœ¼ë©´ ê²€ì€ìƒ‰ */
            background-image: url('../img/background.png'); 
            background-size: cover;
        }

        /* ìƒë‹¨ ì œëª© */
        .game-title {
            text-align: center; font-size: 50px; color: #FFD700; /* GOLD */
            margin-top: 30px; font-weight: bold; text-shadow: 2px 2px 0 #000;
        }

        /* ë¦´(Reel) ì˜ì—­ */
        .reels-area {
            position: absolute; top: 150px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
        }

        .reel {
            width: 150px; height: 200px;
            background-color: white;
            border: 5px solid blue; /* íŒŒì´ì¬ ì½”ë“œì˜ BLUE */
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        .reel img {
            width: 100%; height: 100%; object-fit: contain;
        }

        /* í•˜ë‹¨ ì •ë³´ì°½ */
        .info-area {
            position: absolute; bottom: 50px; left: 50px;
            font-size: 30px; font-weight: bold; text-shadow: 2px 2px 0 #000;
        }

        /* ë©”ì‹œì§€ ì°½ */
        .msg-area {
            position: absolute; bottom: 120px; width: 100%;
            text-align: center; font-size: 30px; font-weight: bold;
            text-shadow: 2px 2px 0 #000;
        }

        /* ì­íŒŸ íŒì—… ì´ë¯¸ì§€ */
        #jackpot-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 600px; height: 400px;
            pointer-events: none; opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #jackpot-overlay.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        #jackpot-overlay img { width: 100%; height: 100%; object-fit: contain; }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (í™”ë©´ ì „ì²´ í´ë¦­ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥í•˜ì§€ë§Œ ëª…ì‹œì  ë²„íŠ¼ ì¶”ê°€) */
        .spin-btn {
            position: absolute; bottom: 50px; right: 50px;
            padding: 15px 30px; font-size: 1.5rem; font-weight: bold;
            background: #ff0055; color: white; border: none; border-radius: 10px;
            cursor: pointer; box-shadow: 0 5px 0 #990033;
        }
        .spin-btn:active { transform: translateY(5px); box-shadow: none; }
        .spin-btn:disabled { background: #555; cursor: not-allowed; }

        /* ë‚˜ê°€ê¸° ë²„íŠ¼ */
        .exit-btn {
            position: absolute; top: 20px; right: 20px;
            text-decoration: none; color: #aaa; font-weight: bold; background: rgba(0,0,0,0.5);
            padding: 5px 10px; border-radius: 5px;
        }
    </style>
</head>
<body>

    <audio id="snd-spin" src="spin.mp3" loop></audio>
    <audio id="snd-jackpot" src="jackpot_alarm.wav"></audio>
    <audio id="snd-win" src="slot-win-coins-mp3.mp3"></audio>
    <audio id="bgm" src="slot_background.mp3" loop></audio>

    <div class="game-frame">
        <a href="game.html" class="exit-btn">ë‚˜ê°€ê¸°</a>
        <div class="game-title">ë£¨ë¯¸ ìŠ¬ë¡¯</div>

        <div class="reels-area">
            <div class="reel"><img id="img1" src="../img/rumi1.png"></div>
            <div class="reel"><img id="img2" src="../img/rumi2.png"></div>
            <div class="reel"><img id="img3" src="../img/rumi3.png"></div>
        </div>

        <div class="msg-area" id="msg">ìŠ¤í•€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</div>

        <div class="info-area">
            <div id="money-display">ì†Œì§€ê¸ˆ: Loading...</div>
            <div>ë² íŒ…: 1,000ì›</div>
        </div>

        <button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN</button>

        <div id="jackpot-overlay"><img src="../img/jackpot.png"></div>
    </div>

    <script>
        // íŒŒì´ì¬ ì½”ë“œì˜ ë¦¬ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
        const symbolImages = [
            "rumi1.png", "rumi2.png", "rumi3.png", "rumi4.png", "rumi_jackpot.png"
        ];
        
        // íŒŒì´ì¬ ë¡œì§ ë³€ìˆ˜
        const betAmount = 1000;
        let isSpinning = false;
        const msgEl = document.getElementById('msg');
        const reels = [document.getElementById('img1'), document.getElementById('img2'), document.getElementById('img3')];
        
        // ì´ˆê¸°í™” (ì§€ê°‘ ì—°ë™)
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateUI();
                // ë°°ê²½ìŒì•… ì¬ìƒ (ì‚¬ìš©ì í´ë¦­ í›„ ì¬ìƒ ì •ì±… ëŒ€ì‘)
                document.body.addEventListener('click', () => {
                    const bgm = document.getElementById('bgm');
                    if(bgm.paused) { bgm.volume = 0.5; bgm.play().catch(()=>{}); }
                }, { once: true });
            }, 500);
        });

        function updateUI() {
            if (typeof myWallet !== 'undefined') {
                document.getElementById('money-display').innerText = `ì†Œì§€ê¸ˆ: ${myWallet.token.toLocaleString()}ì›`; // í† í°ì„ ì›ìœ¼ë¡œ í‘œì‹œ
            }
        }

        async function startSpin() {
            if (isSpinning) return;

            // ì§€ê°‘ ì²´í¬
            if (typeof updateBalance !== 'function') return alert("ì§€ê°‘ ì‹œìŠ¤í…œ ì˜¤ë¥˜");
            if (myWallet.token < betAmount) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");

            // ëˆ ì°¨ê°
            const success = await updateBalance('token', -betAmount);
            if (!success) return alert("ì˜¤ë¥˜ ë°œìƒ");
            updateUI();

            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;
            msgEl.innerText = "í–‰ìš´ì„ ë¹•ë‹ˆë‹¤!";
            
            // ì‚¬ìš´ë“œ ì¬ìƒ
            document.getElementById('snd-spin').play();
            document.getElementById('jackpot-overlay').classList.remove('show'); // ì­íŒŸ ì´ë¯¸ì§€ ìˆ¨ê¹€

            // ì• ë‹ˆë©”ì´ì…˜ (ì´ë¯¸ì§€ ë¹ ë¥´ê²Œ êµì²´)
            let spinInterval = setInterval(() => {
                reels.forEach(img => {
                    const randomImg = symbolImages[Math.floor(Math.random() * symbolImages.length)];
                    img.src = randomImg;
                });
            }, 100);

            // 2ì´ˆ í›„ ë©ˆì¶¤ (íŒŒì´ì¬ ì½”ë“œ: 2000ms)
            setTimeout(() => {
                clearInterval(spinInterval);
                document.getElementById('snd-spin').pause();
                document.getElementById('snd-spin').currentTime = 0;
                
                // ìµœì¢… ê²°ê³¼ ê²°ì •
                const results = [
                    getRandomSymbol(), getRandomSymbol(), getRandomSymbol()
                ];

                // í™”ë©´ ì—…ë°ì´íŠ¸
                reels[0].src = results[0];
                reels[1].src = results[1];
                reels[2].src = results[2];

                checkResult(results);
                
                isSpinning = false;
                document.getElementById('spinBtn').disabled = false;
            }, 2000);
        }

        function getRandomSymbol() {
            return symbolImages[Math.floor(Math.random() * symbolImages.length)];
        }

        // íŒŒì´ì¬ check_result í•¨ìˆ˜ ë¡œì§ ì´ì‹
        async function checkResult(results) {
            // ì´ë¯¸ì§€ íŒŒì¼ëª…ìœ¼ë¡œ ë¹„êµ
            const [r1, r2, r3] = results;
            let win = 0;
            let message = "ì•„ì‰¬ì›Œìš”, ë‹¤ì‹œ ë„ì „!";
            let sound = null;

            // 1. ì­íŒŸ ì‹¬ë³¼ 3ê°œ (ì´ˆëŒ€ë°•)
            if (r1 === "rumi_jackpot.png" && r2 === "rumi_jackpot.png" && r3 === "rumi_jackpot.png") {
                win = betAmount * 50;
                message = `ì´ˆëŒ€ë°•! +${win.toLocaleString()}ì›`;
                sound = 'snd-jackpot';
                showJackpotEffect();
            }
            // 2. ì¼ë°˜ ì‹¬ë³¼ 3ê°œ ì¼ì¹˜ (ì­íŒŸ)
            else if (r1 === r2 && r2 === r3) {
                win = betAmount * 10;
                message = `ì­íŒŸ! +${win.toLocaleString()}ì›`;
                sound = 'snd-jackpot';
                showJackpotEffect();
            }
            // 3. 2ê°œ ì¼ì¹˜ (ì¼ë°˜ ë‹¹ì²¨)
            else if (r1 === r2 || r2 === r3 || r1 === r3) {
                win = Math.floor(betAmount * 1.5);
                message = `2ê°œ ì¼ì¹˜! +${win.toLocaleString()}ì›`;
                sound = 'snd-win';
            }

            msgEl.innerText = message;
            msgEl.style.color = win > 0 ? "#FFD700" : "white";

            if (win > 0) {
                await updateBalance('token', win);
                updateUI();
                if (sound) document.getElementById(sound).play();
            }
        }

        function showJackpotEffect() {
            const overlay = document.getElementById('jackpot-overlay');
            overlay.classList.add('show');
            // 3ì´ˆ ë’¤ì— ì‚¬ë¼ì§
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>