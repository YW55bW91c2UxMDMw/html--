<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR - ADMIN CONSOLE</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ğŸ”´ ê´€ë¦¬ì ì „ìš© í…Œë§ˆ (Red Alert) */
        :root {
            --bg-deep: #0a0000;
            --accent: #ff0040;
            --text-main: #ffffff;
            --glass-bg: rgba(40, 0, 0, 0.8);
            --border: rgba(255, 0, 64, 0.3);
        }
        body {
            background: var(--bg-deep); color: var(--text-main); font-family: 'Pretendard';
            padding: 40px; text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 { color: var(--accent); font-size: 3rem; text-shadow: 0 0 20px var(--accent); margin-bottom: 40px; }
        
        .panel {
            background: var(--glass-bg); border: 1px solid var(--accent);
            padding: 30px; border-radius: 15px; margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(255, 0, 64, 0.1); text-align: left;
        }
        .panel h2 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; color: var(--accent); }
        
        /* í†µê³„ ê·¸ë¦¬ë“œ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        .stat-box { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; border: 1px solid #555; text-align: center; }
        .stat-val { font-size: 2rem; font-weight: bold; color: white; margin-top: 10px; }

        /* ì…ë ¥ ë° ë²„íŠ¼ */
        input {
            padding: 10px; width: 200px; background: #220000; border: 1px solid var(--accent); 
            color: white; border-radius: 5px; outline: none;
        }
        .btn-admin {
            background: var(--accent); color: white; border: none; padding: 10px 20px;
            font-size: 1rem; font-weight: bold; cursor: pointer; border-radius: 5px;
            transition: 0.3s;
        }
        .btn-admin:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--accent); }
        
        /* ìœ ì € ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */
        .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .user-table th { text-align: left; padding: 10px; color: var(--accent); border-bottom: 1px solid var(--border); }
        .user-table td { padding: 10px; border-bottom: 1px solid #330000; }
        .user-table tr:hover { background: rgba(255, 0, 64, 0.1); }
        
        .badge-admin { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }
        .val-money { color: #00ff9d; }
        .val-token { color: #ffd700; }

        .back-link { color: #666; text-decoration: none; display: inline-block; margin-top: 20px; }
        .refresh-btn { float: right; font-size: 0.8rem; background: none; border: 1px solid #555; color: #aaa; cursor: pointer; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ADMIN CONSOLE</h1>
        
        <div class="panel">
            <h2>SYSTEM STATUS</h2>
            <div class="stat-grid">
                <div class="stat-box">
                    <div style="color:#aaa;">TOTAL USERS</div>
                    <div id="stat-users" class="stat-val">Loading...</div>
                </div>
                <div class="stat-box">
                    <div style="color:#aaa;">TOTAL SUPPLY (TOKEN)</div>
                    <div id="stat-tokens" class="stat-val">Loading...</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>EMERGENCY MINTING</h2>
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px;">
                ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹œì¥ì— í’€ì§€ ì•Šê³ , <b>ê´€ë¦¬ì ê°œì¸ ì§€ê°‘</b>ìœ¼ë¡œ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.
            </p>
            <input type="number" id="mint-amount" value="1000000">
            <button class="btn-admin" onclick="mintTokens()">GENERATE</button>
        </div>

        <div class="panel">
            <h2>
                USER MANAGEMENT
                <button class="refresh-btn" onclick="loadUserList()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </h2>
            <div style="overflow-x: auto;">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID (Username)</th>
                            <th>Nickname</th>
                            <th>Money (KRW)</th>
                            <th>Token (JDS)</th>
                            <th>Stardust</th>
                            <th>Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <a href="/" class="back-link">â† Return to Main</a>
    </div>

    <script>
        // â˜… Supabase ì„¤ì • (ë³¸ì¸ í‚¤ë¡œ êµì²´!)
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4';
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        window.onload = async () => {
            const { data: { user } } = await client.auth.getUser();
            if (!user) { location.href = '/'; return; }

            // ê´€ë¦¬ì ì—¬ë¶€ ì¬í™•ì¸
            const { data: profile } = await client.from('profiles').select('is_admin').eq('id', user.id).single();
            
            if (!profile || !profile.is_admin) {
                alert("â›” ì ‘ê·¼ ê±°ë¶€: ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                location.href = '/';
                return;
            }

            loadStats();
            loadUserList();
        };

        // ì „ì²´ í†µê³„ ë¡œë“œ
        async function loadStats() {
            const { data, error } = await client.rpc('get_market_stats');
            if (data) {
                document.getElementById('stat-users').innerText = data.total_users || '-';
                document.getElementById('stat-tokens').innerText = (data.total_tokens || 0).toLocaleString();
            }
        }

        // íšŒì› ëª©ë¡ ë¡œë“œ (í•µì‹¬ ê¸°ëŠ¥)
        async function loadUserList() {
            const tbody = document.getElementById('user-list-body');
            
            // ì•„ê¹Œ ë§Œë“  SQL í•¨ìˆ˜ í˜¸ì¶œ
            const { data, error } = await client.rpc('get_admin_user_list');

            if (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ë¡œë“œ ì‹¤íŒ¨: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            tbody.innerHTML = '';
            data.forEach(user => {
                const tr = document.createElement('tr');
                
                // ê´€ë¦¬ì ë±ƒì§€
                const adminBadge = user.is_admin ? '<span class="badge-admin">ADMIN</span>' : '';
                
                // ë‚ ì§œ í¬ë§·
                const lastActive = user.last_mined_at 
                    ? new Date(user.last_mined_at).toLocaleDateString() 
                    : '-';

                tr.innerHTML = `
                    <td style="font-weight:bold; color:white;">${user.username || 'Unknown'} ${adminBadge}</td>
                    <td>${user.nickname || '-'}</td>
                    <td class="val-money">${user.money.toLocaleString()}</td>
                    <td class="val-token">${user.token.toLocaleString()}</td>
                    <td style="color:#bf00ff;">${user.stardust.toLocaleString()}</td>
                    <td style="color:#888;">${lastActive}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // í† í° ë°œí–‰
        async function mintTokens() {
            const amount = document.getElementById('mint-amount').value;
            if(!amount) return;

            const { error } = await client.rpc('admin_mint_token', { amount: parseInt(amount) });
            
            if (error) alert("ì˜¤ë¥˜: " + error.message);
            else {
                alert(`âœ… ${parseInt(amount).toLocaleString()} í† í° ìƒì„± ì™„ë£Œ!`);
                loadStats();     // í†µê³„ ê°±ì‹ 
                loadUserList();  // ë¦¬ìŠ¤íŠ¸ ê°±ì‹  (ë‚´ ì”ê³ ê°€ ëŠ˜ì–´ë‚¬ìœ¼ë‹ˆ)
            }
        }
    </script>
</body>
</html>