<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR - Software Depot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="wallet.js"></script> <style>
        /* üåå [JindoStar Ìï¥Ï†Å ÌÖåÎßà] */
        :root {
            --bg-deep: #050510;
            --accent: #00d4ff;       
            --premium: #ff4f6d;      /* Ïú†Î£å (VIP) */
            --free: #00ff9d;         /* Î¨¥Î£å */
            --glass-bg: rgba(20, 20, 35, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #eeeeee;
            --text-sub: #888888;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', monospace;
            background-color: var(--bg-deep); color: var(--text-main);
            background-image: 
                linear-gradient(rgba(0, 255, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            min-height: 100vh;
        }

        .top-bar {
            padding: 15px 20px; background: #000; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; width: 100%; z-index: 100;
        }
        .logo { font-weight: 900; color: var(--accent); letter-spacing: 2px; text-decoration: none; }

        .container { max-width: 1000px; margin: 80px auto 40px auto; padding: 0 15px; }

        .torrent-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .torrent-table th { text-align: left; padding: 10px; background: rgba(255,255,255,0.05); color: var(--text-sub); border-bottom: 2px solid #333; }
        .torrent-table td { padding: 12px 10px; border-bottom: 1px solid #222; vertical-align: middle; }
        .torrent-table tr:hover { background: rgba(255,255,255,0.02); }

        .vip-tag { background: var(--premium); color: #000; font-weight: bold; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px; }
        .free-tag { background: var(--free); color: #000; font-weight: bold; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px; }

        /* Î≤ÑÌäº */
        .action-btn {
            display: inline-block; padding: 6px 12px; border: 1px solid #444; border-radius: 4px;
            font-size: 0.8rem; cursor: pointer; transition: 0.3s; text-decoration: none;
        }
        .btn-down { color: var(--free); border-color: var(--free); }
        .btn-down:hover { background: var(--free); color: black; }
        
        .btn-buy { color: var(--premium); border-color: var(--premium); }
        .btn-buy:hover { background: var(--premium); color: black; }

        /* Î≥µÌï© Í≤∞Ï†ú Î≤ÑÌäº (JDS + Dust) */
        .btn-mix { color: #bf00ff; border-color: #bf00ff; }
        .btn-mix:hover { background: #bf00ff; color: white; }

        @media (max-width: 600px) { .hide-mobile { display: none; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="/" class="logo">JINDO_WAREZ</a>
        <div style="font-size:0.8rem; color:#666;">
            Wallet: <span id="my-wallet-info">Loading...</span>
        </div>
    </div>

    <div class="container">
        <h2 style="margin-bottom:20px; color:var(--accent);">Software Repository</h2>
        <table class="torrent-table">
            <thead>
                <tr>
                    <th width="50%">Name / Cost</th>
                    <th width="15%" class="hide-mobile">Size</th>
                    <th width="35%" style="text-align:right;">Action</th>
                </tr>
            </thead>
            <tbody id="program-list">
                <tr><td colspan="3" style="text-align:center; padding:30px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // SupabaseÎäî wallet.jsÏóêÏÑú window.clientÎ°ú ÏÇ¨Ïö©
        let myWalletData = { token: 0, stardust: 0 };

        window.addEventListener('load', async () => {
            setTimeout(async () => {
                if(!window.client) return;
                await updateWalletDisplay();
                loadPrograms();
            }, 500);
        });

        async function updateWalletDisplay() {
            const { data: { user } } = await window.client.auth.getUser();
            if(user) {
                const { data } = await window.client.from('profiles').select('token, stardust').eq('id', user.id).single();
                if(data) {
                    myWalletData = data;
                    document.getElementById('my-wallet-info').innerText = `${data.token} T / ${data.stardust} D`;
                }
            }
        }

        async function loadPrograms() {
            const { data } = await window.client.from('programs').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('program-list');
            list.innerHTML = '';

            if(!data) return list.innerHTML = '<tr><td colspan="3">No Data</td></tr>';

            data.forEach(item => {
                let badge = '', btn = '';
                
                // Í∞ÄÍ≤© Ï†ïÏ±Ö ÌôïÏù∏
                const priceToken = item.price || 0;
                const priceDust = item.price_dust || 0;

                if (priceToken === 0 && priceDust === 0) {
                    // Î¨¥Î£å
                    badge = `<span class="free-tag">Free</span>`;
                    btn = `<a href="${item.download_url}" class="action-btn btn-down" download>üíæ Download</a>`;
                } else if (priceDust > 0) {
                    // Î≥µÌï© Í≤∞Ï†ú (VIP)
                    badge = `<span class="vip-tag" style="background:#bf00ff; color:white;">${priceToken}T + ${priceDust}D</span>`;
                    btn = `<button class="action-btn btn-mix" onclick="purchase('${item.title}', ${priceToken}, ${priceDust}, '${item.download_url}')">üõí Purchase</button>`;
                } else {
                    // ÏùºÎ∞ò Ïú†Î£å
                    badge = `<span class="vip-tag">${priceToken} Token</span>`;
                    btn = `<button class="action-btn btn-buy" onclick="purchase('${item.title}', ${priceToken}, 0, '${item.download_url}')">üõí Buy</button>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${item.title} ${badge}</div>
                        <div style="font-size:0.8rem; color:#666;">${item.description || 'No description'}</div>
                    </td>
                    <td class="hide-mobile">${item.size || 'Unknown'}</td>
                    <td style="text-align:right;">${btn}</td>
                `;
                list.appendChild(tr);
            });
        }

        // [ÌïµÏã¨] Íµ¨Îß§ Ìï®Ïàò
        async function purchase(title, costToken, costDust, url) {
            // ÏûîÏï° 1Ï∞® ÌôïÏù∏ (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏)
            if (myWalletData.token < costToken) return alert("ÌÜ†ÌÅ∞Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!");
            if (myWalletData.stardust < costDust) return alert("Ïä§ÌÉÄÎçîÏä§Ìä∏Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!");

            if (!confirm(`[${title}]ÏùÑ(Î•º) Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎπÑÏö©: ${costToken} Token + ${costDust} Dust`)) return;

            // ÏÑúÎ≤Ñ(DB) Í≤∞Ï†ú ÏöîÏ≤≠
            const { data, error } = await window.client.rpc('purchase_item', {
                item_name: title,
                cost_token: costToken,
                cost_dust: costDust
            });

            if (data === 'success') {
                alert("‚úÖ Íµ¨Îß§ ÏôÑÎ£å! Îã§Ïö¥Î°úÎìúÍ∞Ä ÏãúÏûëÎê©ÎãàÎã§.");
                await updateWalletDisplay(); // ÏûîÏï° Í∞±Ïã†
                window.location.href = url; // ÌååÏùº Îã§Ïö¥Î°úÎìú
            } else {
                alert("Í≤∞Ï†ú Ïã§Ìå®: " + (error ? error.message : data));
            }
        }
    </script>
</body>
</html>