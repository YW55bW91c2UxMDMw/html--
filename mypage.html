<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR - ë§ˆì´ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="wallet.js"></script>

    <style>
        /* ğŸŒŒ [Deep Space Design System] */
        :root {
            --bg-deep: #050510;
            --bg-card: rgba(20, 20, 35, 0.6);
            --accent: #00d4ff;       /* ë„¤ì˜¨ ì‹œì•ˆ */
            --accent-glow: rgba(0, 212, 255, 0.4);
            --glass-bg: rgba(20, 20, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sub: #a4a4c5;
            --win-color: #00ff9d;
            --lose-color: #ff4f6d;
            --dust-color: #bf00ff; /* ìŠ¤íƒ€ë”ìŠ¤íŠ¸ ìƒ‰ìƒ */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .top-bar {
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
            display: flex; gap: 15px; align-items: center;
            position: fixed; top: 0; width: 100%; z-index: 100;
        }
        .top-bar a { text-decoration: none; color: var(--text-sub); transition: 0.3s; }
        .top-bar a:hover { color: var(--accent); }
        .logo { font-weight: 900; color: var(--accent); letter-spacing: 1px; margin-right: 20px; }

        .container {
            max-width: 900px; margin: 100px auto 50px auto; padding: 0 20px;
        }

        /* í”„ë¡œí•„ í—¤ë” ì„¹ì…˜ */
        .profile-header {
            display: flex; align-items: center; gap: 20px; margin-bottom: 30px;
            background: var(--bg-card); padding: 30px; border-radius: 20px;
            border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
            position: relative; overflow: hidden;
        }
        .profile-avatar {
            width: 80px; height: 80px; background: #000; border-radius: 50%;
            border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; box-shadow: 0 0 20px var(--accent-glow);
        }
        .profile-info h1 { margin: 0; font-size: 1.8rem; color: white; display: flex; align-items: center; gap: 10px; }
        .profile-info p { margin: 5px 0 0 0; color: var(--text-sub); font-size: 0.9rem; }
        .edit-btn { 
            font-size: 0.8rem; background: transparent; border: 1px solid var(--glass-border); 
            color: var(--text-sub); padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 10px;
        }
        .edit-btn:hover { color: var(--accent); border-color: var(--accent); }

        /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;
        }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            background: var(--bg-card); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }
        .card h2 { 
            margin-top: 0; margin-bottom: 20px; color: var(--accent); font-size: 1.2rem; 
            text-shadow: 0 0 10px var(--accent-glow); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;
        }

        /* ìì‚° ë°•ìŠ¤ */
        .asset-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .asset-value { font-size: 1.5rem; font-weight: bold; }
        .money { color: var(--win-color); text-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }
        .token { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .dust { color: var(--dust-color); text-shadow: 0 0 10px rgba(191, 0, 255, 0.3); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 15px; font-size: 0.9rem; font-weight: bold;
            background: linear-gradient(135deg, var(--accent), #006eff);
            color: #000; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s;
            text-align: center; width: 100%; margin-top: auto; text-decoration: none; display: block;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px var(--accent-glow); color: white; }
        
        .btn-outline {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-sub);
        }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 10px; color: var(--accent); border-bottom: 1px solid var(--glass-border); }
        td { padding: 10px; border-bottom: 1px solid var(--glass-border); color: var(--text-main); }
        .win { color: var(--win-color); }
        .lose { color: var(--lose-color); }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #101020; border: 1px solid var(--accent); padding: 30px; border-radius: 15px;
            width: 90%; max-width: 400px; box-shadow: 0 0 30px var(--accent-glow);
        }
        input {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border);
            color: white; border-radius: 5px; margin-bottom: 15px; outline: none;
        }
        input:focus { border-color: var(--accent); }

        @media (max-width: 600px) {
            .profile-header { flex-direction: column; text-align: center; }
            .grid-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="top-bar">
        <a href="/" class="logo">ğŸ¦Š JINDOSTAR</a>
        <a href="/">ë©”ì¸ìœ¼ë¡œ</a>
        <a href="game.html">ê²Œì„í•˜ê¸°</a>
        <a href="#" style="color:var(--accent);">ë§ˆì´í˜ì´ì§€</a>
        <div id="auth-ui" style="margin-left: auto;"></div>
    </nav>

    <div class="container">
        <div class="profile-header">
            <div class="profile-avatar">ğŸ‘¨â€ğŸš€</div>
            <div class="profile-info">
                <h1>
                    <span id="display-nick">ë°ì´í„° ë¡œë”©ì¤‘...</span>
                    <button class="edit-btn" onclick="openNickModal()">âœï¸ ìˆ˜ì •</button>
                </h1>
                <p id="display-email">user@jindostar.net</p>
                <p style="font-size:0.8rem; color:#666; margin-top:5px;">
                    UID: <span id="display-uid">...</span>
                </p>
                <p style="font-size:0.8rem; color:var(--accent); margin-top:5px; display:none;" id="mail-addr-box">
                    ğŸ“§ <span id="display-mail-addr"></span>
                </p>
            </div>
        </div>

        <div class="grid-container">
            <div class="card">
                <h2>MY WALLET</h2>
                <div class="asset-row">
                    <span style="color:var(--text-sub);">ë³´ìœ  í˜„ê¸ˆ</span>
                    <span class="asset-value money"><span id="my-money">0</span> â‚©</span>
                </div>
                <div class="asset-row">
                    <span style="color:var(--text-sub);">ë³´ìœ  í† í°</span>
                    <span class="asset-value token"><span id="my-token">0</span> JDS</span>
                </div>
                <div class="asset-row">
                    <span style="color:var(--text-sub);">ìŠ¤íƒ€ë”ìŠ¤íŠ¸</span>
                    <span class="asset-value dust"><span id="my-stardust">0</span> Dust</span>
                </div>
                <button class="btn btn-outline" onclick="location.href='exchange.html'">ğŸ“ˆ ê±°ë˜ì†Œ ê°€ê¸°</button>
            </div>

            <div class="card">
                <h2>GALAXY MINING â›ï¸</h2>
                <div style="text-align:center; padding:10px;">
                    <p style="color:var(--text-sub); margin-bottom:20px;">
                        ìš°ì£¼ ê´‘ì‚°ì—ì„œ ê´‘ë¬¼ì„ ì±„êµ´í•˜ê³ <br>í† í°ìœ¼ë¡œ êµí™˜í•˜ì„¸ìš”.
                    </p>
                    <a href="mining.html" class="btn">ğŸš€ ê´‘ì‚°ìœ¼ë¡œ ì´ë™</a>
                </div>
            </div>
            
            <div class="card">
                <h2>INVENTORY ğŸ’</h2>
                <div style="text-align:center; color:#555; padding:30px 0;">
                    <div style="font-size:2rem; margin-bottom:10px;">ğŸ”’</div>
                    ì•„ì´í…œ ë³´ê´€í•¨ì´ ì ê²¨ìˆìŠµë‹ˆë‹¤.<br>
                    (ì—…ë°ì´íŠ¸ ì˜ˆì •)
                </div>
            </div>
        </div>

        <div class="card">
            <h2>GAME HISTORY</h2>
            <div style="overflow-x: auto;">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>GAME</th>
                            <th>BET</th>
                            <th>RESULT</th>
                            <th>TIME</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
            <div id="empty-history" style="text-align:center; padding:20px; color:#555; display:none;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="nick-modal" class="modal">
        <div class="modal-box">
            <h3 style="color:white; margin-top:0;">ë‹‰ë„¤ì„ ë³€ê²½</h3>
            <input type="text" id="new-nickname" placeholder="ìƒˆ ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 10ì)">
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="updateNickname()">ë³€ê²½í•˜ê¸°</button>
                <button class="btn btn-outline" onclick="document.getElementById('nick-modal').style.display='none'">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // [ì¤‘ìš”] wallet.jsê°€ ë¡œë“œëœ í›„ì— ì‹¤í–‰ë  í•¨ìˆ˜ì…ë‹ˆë‹¤.
        // wallet.js ë‚´ë¶€ì˜ window.onloadì—ì„œ í˜¸ì¶œí•©ë‹ˆë‹¤.
        function initPage() {
            setTimeout(async () => {
                // wallet.jsì—ì„œ ìƒì„±í•œ window.client ì‚¬ìš©
                if (!window.client) return console.error("wallet.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

                const { data: { user } } = await window.client.auth.getUser();
                if (!user) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    location.href = 'index.html';
                    return;
                }

                // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
                document.getElementById('display-email').innerText = user.email;
                document.getElementById('display-uid').innerText = user.id.slice(0, 8) + "...";

                // í”„ë¡œí•„ ìƒì„¸ ë° íˆìŠ¤í† ë¦¬ ë¡œë“œ
                loadProfileDetail(user.id);
                loadHistory(user.id);
            }, 500); // wallet.js ì´ˆê¸°í™” ëŒ€ê¸°
        }

        // ìƒì„¸ í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ì§€ê°‘ ìˆ«ìëŠ” wallet.jsê°€ ìë™ ê°±ì‹ í•˜ë¯€ë¡œ ë‹‰ë„¤ì„/ì±„êµ´ì •ë³´ ìœ„ì£¼)
        async function loadProfileDetail(userId) {
            const { data, error } = await window.client
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();

            if (data) {
                // ë‹‰ë„¤ì„ í‘œì‹œ
                document.getElementById('display-nick').innerText = data.nickname || 'ì´ë¦„ ì—†ëŠ” íƒì‚¬ëŒ€ì›';
                
                // Jindo Mail ì£¼ì†Œ í‘œì‹œ
                if (data.username) {
                    document.getElementById('display-mail-addr').innerText = data.username + "@jindostar.net";
                    document.getElementById('mail-addr-box').style.display = 'block';
                }
                
                // ì§€ê°‘ UI ê°•ì œ ì—…ë°ì´íŠ¸ (wallet.jsì˜ ë°ì´í„°ê°€ ì•„ì§ ì•ˆ ì™”ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                document.getElementById('my-money').innerText = data.money.toLocaleString();
                document.getElementById('my-token').innerText = data.token.toLocaleString();
                document.getElementById('my-stardust').innerText = (data.stardust || 0).toLocaleString();
            }
        }

        // [ê¸°ëŠ¥] ë‹‰ë„¤ì„ ë³€ê²½
        function openNickModal() {
            document.getElementById('nick-modal').style.display = 'flex';
        }

        async function updateNickname() {
            const newNick = document.getElementById('new-nickname').value.trim();
            if (!newNick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if (newNick.length > 10) return alert("10ì ì´ë‚´ë¡œ ì…ë ¥í•˜ì„¸ìš”.");

            const { data: { user } } = await window.client.auth.getUser();
            
            const { error } = await window.client
                .from('profiles')
                .update({ nickname: newNick })
                .eq('id', user.id);

            if (error) {
                alert("ë³€ê²½ ì‹¤íŒ¨: " + error.message);
            } else {
                alert("ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('display-nick').innerText = newNick;
                document.getElementById('nick-modal').style.display = 'none';
            }
        }

        // [ê¸°ëŠ¥] ì „ì  ê¸°ë¡
        async function loadHistory(userId) {
            const { data: logs } = await window.client
                .from('game_logs')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(10);

            const list = document.getElementById('history-list');
            list.innerHTML = ''; // ì´ˆê¸°í™”

            if (!logs || logs.length === 0) {
                document.getElementById('empty-history').style.display = 'block';
                return;
            }
            
            document.getElementById('empty-history').style.display = 'none';

            logs.forEach(log => {
                const row = document.createElement('tr');
                let resultHtml = log.result_amount > 0 
                    ? `<span class="win">+${log.result_amount}</span>` 
                    : `<span class="lose">-${log.bet_amount}</span>`;
                
                const date = new Date(log.created_at);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;

                row.innerHTML = `
                    <td style="font-weight:bold; color:#fff;">${log.game_name}</td>
                    <td>${log.bet_amount}</td>
                    <td>${resultHtml}</td>
                    <td style="color:var(--text-sub); font-size:0.8em;">${dateStr}</td>
                `;
                list.appendChild(row);
            });
        }
    </script>
</body>
</html>