<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR - ë§ˆì´ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ğŸŒŒ [Deep Space Design System] */
        :root {
            --bg-deep: #050510;
            --bg-card: rgba(20, 20, 35, 0.6);
            --accent: #00d4ff;       /* ë„¤ì˜¨ ì‹œì•ˆ */
            --accent-glow: rgba(0, 212, 255, 0.4);
            --glass-bg: rgba(20, 20, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sub: #a4a4c5;
            --win-color: #00ff9d;
            --lose-color: #ff4f6d;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .top-bar {
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
            display: flex; gap: 15px; align-items: center;
            position: fixed; top: 0; width: 100%; z-index: 100;
        }
        .top-bar a { text-decoration: none; color: var(--text-sub); transition: 0.3s; }
        .top-bar a:hover { color: var(--accent); }
        .logo { font-weight: 900; color: var(--accent); letter-spacing: 1px; margin-right: 20px; }

        .container {
            max-width: 900px; margin: 100px auto 50px auto; padding: 0 20px;
        }

        /* í”„ë¡œí•„ í—¤ë” ì„¹ì…˜ */
        .profile-header {
            display: flex; align-items: center; gap: 20px; margin-bottom: 30px;
            background: var(--bg-card); padding: 30px; border-radius: 20px;
            border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
            position: relative; overflow: hidden;
        }
        .profile-avatar {
            width: 80px; height: 80px; background: #000; border-radius: 50%;
            border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; box-shadow: 0 0 20px var(--accent-glow);
        }
        .profile-info h1 { margin: 0; font-size: 1.8rem; color: white; display: flex; align-items: center; gap: 10px; }
        .profile-info p { margin: 5px 0 0 0; color: var(--text-sub); font-size: 0.9rem; }
        .edit-btn { 
            font-size: 0.8rem; background: transparent; border: 1px solid var(--glass-border); 
            color: var(--text-sub); padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 10px;
        }
        .edit-btn:hover { color: var(--accent); border-color: var(--accent); }

        /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;
        }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            background: var(--bg-card); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 25px; box-shadow: 0 0 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }
        .card h2 { 
            margin-top: 0; margin-bottom: 20px; color: var(--accent); font-size: 1.2rem; 
            text-shadow: 0 0 10px var(--accent-glow); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;
        }

        /* ìì‚° ë°•ìŠ¤ */
        .asset-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .asset-value { font-size: 1.5rem; font-weight: bold; }
        .money { color: var(--win-color); text-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }
        .token { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 15px; font-size: 0.9rem; font-weight: bold;
            background: linear-gradient(135deg, var(--accent), #006eff);
            color: #000; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s;
            text-align: center; width: 100%; margin-top: auto;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px var(--accent-glow); color: white; }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-outline {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-sub);
        }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 10px; color: var(--accent); border-bottom: 1px solid var(--glass-border); }
        td { padding: 10px; border-bottom: 1px solid var(--glass-border); color: var(--text-main); }
        .win { color: var(--win-color); }
        .lose { color: var(--lose-color); }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #101020; border: 1px solid var(--accent); padding: 30px; border-radius: 15px;
            width: 90%; max-width: 400px; box-shadow: 0 0 30px var(--accent-glow);
        }
        input {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border);
            color: white; border-radius: 5px; margin-bottom: 15px; outline: none;
        }
        input:focus { border-color: var(--accent); }

        @media (max-width: 600px) {
            .profile-header { flex-direction: column; text-align: center; }
            .grid-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="top-bar">
        <a href="/" class="logo">ğŸ¦Š JINDOSTAR</a>
        <a href="/">ë©”ì¸ìœ¼ë¡œ</a>
        <a href="game.html">ê²Œì„í•˜ê¸°</a>
        <a href="#" style="color:var(--accent);">ë§ˆì´í˜ì´ì§€</a>
    </nav>

    <div class="container">
        <div class="profile-header">
            <div class="profile-avatar">ğŸ‘¨â€ğŸš€</div>
            <div class="profile-info">
                <h1>
                    <span id="display-nick">ë°ì´í„° ë¡œë”©ì¤‘...</span>
                    <button class="edit-btn" onclick="openNickModal()">âœï¸ ìˆ˜ì •</button>
                </h1>
                <p id="display-email">user@jindostar.com</p>
                <p style="font-size:0.8rem; color:#666; margin-top:5px;">
                    UID: <span id="display-uid">...</span>
                </p>
                <p style="font-size:0.8rem; color:var(--accent); margin-top:5px; display:none;" id="mail-addr-box">
                    ğŸ“§ <span id="display-mail-addr"></span>
                </p>
            </div>
        </div>

        <div class="grid-container">
            <div class="card">
                <h2>MY WALLET</h2>
                <div class="asset-row">
                    <span style="color:var(--text-sub);">ë³´ìœ  í˜„ê¸ˆ</span>
                    <span class="asset-value money"><span id="my-money">0</span> â‚©</span>
                </div>
                <div class="asset-row">
                    <span style="color:var(--text-sub);">ë³´ìœ  í† í°</span>
                    <span class="asset-value token"><span id="my-token">0</span> ğŸª™</span>
                </div>
                <button class="btn btn-outline" onclick="location.href='game.html'">ê²Œì„í•˜ëŸ¬ ê°€ê¸°</button>
            </div>

            <div class="card">
                <h2>DAILY MINING â›ï¸</h2>
                <div style="text-align:center; padding:10px;">
                    <p style="color:var(--text-sub); margin-bottom:20px;">
                        í–‰ì„±ì—ì„œ ìì›ì„ ì±„êµ´í•˜ì—¬<br>ë¬´ë£Œ í† í°ì„ íšë“í•˜ì„¸ìš”! (1ì¼ 1íšŒ)
                    </p>
                    <button id="mining-btn" class="btn" onclick="doMining()">ğŸš€ ì±„êµ´ ì‹œì‘ (Click)</button>
                    <p id="mining-timer" style="color:var(--lose-color); font-size:0.8rem; margin-top:10px; display:none;">
                        ì´ë¯¸ ì±„êµ´í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì˜¤ì„¸ìš”.
                    </p>
                </div>
            </div>
            
            <div class="card">
                <h2>INVENTORY ğŸ’</h2>
                <div style="text-align:center; color:#555; padding:30px 0;">
                    <div style="font-size:2rem; margin-bottom:10px;">ğŸ”’</div>
                    ì•„ì´í…œ ë³´ê´€í•¨ì´ ì ê²¨ìˆìŠµë‹ˆë‹¤.<br>
                    (ì—…ë°ì´íŠ¸ ì˜ˆì •)
                </div>
            </div>
        </div>

        <div class="card">
            <h2>GAME HISTORY</h2>
            <div style="overflow-x: auto;">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>GAME</th>
                            <th>BET</th>
                            <th>RESULT</th>
                            <th>TIME</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
            <div id="empty-history" style="text-align:center; padding:20px; color:#555; display:none;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="nick-modal" class="modal">
        <div class="modal-box">
            <h3 style="color:white; margin-top:0;">ë‹‰ë„¤ì„ ë³€ê²½</h3>
            <input type="text" id="new-nickname" placeholder="ìƒˆ ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 10ì)">
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="updateNickname()">ë³€ê²½í•˜ê¸°</button>
                <button class="btn btn-outline" onclick="document.getElementById('nick-modal').style.display='none'">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================
        // [í•„ìˆ˜] Supabase ì—°ê²° í‚¤ (index.htmlê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤)
        // =================================================
        const supabaseUrl = 'https://podegnqsxajvtegplsvo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvZGVnbnFzeGFqdnRlZ3Bsc3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzgyMjMsImV4cCI6MjA3OTExNDIyM30.uq9VhsOyJYDtarKIDAxGnoq_K1BHCOp4DFp57rUSEL4';
        
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.onload = async () => {
            // 1. í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
            const { data: { user } } = await supabase.auth.getUser();
            
            // ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ìˆìœ¼ë©´ ë©”ì¸ìœ¼ë¡œ ì«“ì•„ëƒ„
            if (!user) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                location.href = 'index.html';
                return;
            }

            // 2. í™”ë©´ì— ê¸°ë³¸ ì •ë³´ í‘œì‹œ (ì´ë©”ì¼ ë“±)
            document.getElementById('display-email').innerText = user.email;
            document.getElementById('display-uid').innerText = user.id.slice(0, 8) + "...";

            // 3. DBì—ì„œ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            loadProfile(user.id);
            loadHistory(user.id);
        };

        // í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadProfile(userId) {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();

            if (data) {
                document.getElementById('my-money').innerText = data.money.toLocaleString();
                document.getElementById('my-token').innerText = data.token.toLocaleString();
                document.getElementById('display-nick').innerText = data.nickname || 'ì´ë¦„ ì—†ëŠ” íƒì‚¬ëŒ€ì›';
                
                // Jindo Mail ì£¼ì†Œê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (data.username) {
                    document.getElementById('display-mail-addr').innerText = data.username + "@jindostar.net";
                    document.getElementById('mail-addr-box').style.display = 'block';
                }

                // ì±„êµ´ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                checkMiningStatus(data.last_mined_at);
            } else {
                console.log("í”„ë¡œí•„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ˆê¸°í™” í•„ìš”)");
                // ë§Œì•½ í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ wallet.jsë‚˜ index.htmlì˜ ë¡œì§ì—ì„œ ìƒì„±ë˜ì–´ì•¼ í•¨
            }
        }

        // ì±„êµ´ ìƒíƒœ í™•ì¸ (24ì‹œê°„ ì²´í¬)
        function checkMiningStatus(lastMined) {
            const btn = document.getElementById('mining-btn');
            const timer = document.getElementById('mining-timer');
            
            if (!lastMined) return; // ì±„êµ´í•œ ì  ì—†ìœ¼ë©´ ë²„íŠ¼ í™œì„±í™” ìœ ì§€

            const lastDate = new Date(lastMined);
            const now = new Date();
            const diff = now - lastDate; // ë°€ë¦¬ì´ˆ ì°¨ì´
            const oneDay = 24 * 60 * 60 * 1000;

            if (diff < oneDay) {
                // ì•„ì§ í•˜ë£¨ ì•ˆ ì§€ë‚¨
                btn.disabled = true;
                btn.innerText = "â³ ì¶©ì „ ì¤‘...";
                timer.style.display = 'block';
                
                // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
                const remain = new Date(lastDate.getTime() + oneDay) - now;
                const hours = Math.floor(remain / (1000 * 60 * 60));
                timer.innerText = `${hours}ì‹œê°„ ë’¤ì— ë‹¤ì‹œ ì±„êµ´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
            }
        }

        // [ê¸°ëŠ¥ 1] ì¼ì¼ ì±„êµ´ ì‹¤í–‰
        async function doMining() {
            const btn = document.getElementById('mining-btn');
            btn.disabled = true;
            btn.innerText = "â›ï¸ ì±„êµ´ ì¤‘...";

            // DB í•¨ìˆ˜ í˜¸ì¶œ (Supabase SQL í•¨ìˆ˜ í•„ìš”)
            const { data, error } = await supabase.rpc('daily_mining');

            if (error) {
                // SQL í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚¨
                console.error(error);
                alert("ì±„êµ´ ì‹œìŠ¤í…œ ì˜¤ë¥˜: DB í•¨ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                btn.disabled = false;
            } else if (data === -1) {
                alert("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì±„êµ´í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì˜¤ì„¸ìš”!");
                location.reload();
            } else {
                alert(`ğŸ‰ ì±„êµ´ ì„±ê³µ! +${data} í† í°ì„ íšë“í–ˆìŠµë‹ˆë‹¤.`);
                location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ì”ì•¡ ê°±ì‹ 
            }
        }

        // [ê¸°ëŠ¥ 2] ë‹‰ë„¤ì„ ë³€ê²½
        function openNickModal() {
            document.getElementById('nick-modal').style.display = 'flex';
        }

        async function updateNickname() {
            const newNick = document.getElementById('new-nickname').value.trim();
            if (!newNick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if (newNick.length > 10) return alert("10ì ì´ë‚´ë¡œ ì…ë ¥í•˜ì„¸ìš”.");

            const { data: { user } } = await supabase.auth.getUser();
            
            const { error } = await supabase
                .from('profiles')
                .update({ nickname: newNick })
                .eq('id', user.id);

            if (error) {
                alert("ë³€ê²½ ì‹¤íŒ¨: " + error.message);
            } else {
                alert("ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('display-nick').innerText = newNick;
                document.getElementById('nick-modal').style.display = 'none';
            }
        }

        // [ê¸°ëŠ¥ 3] ì „ì  ê¸°ë¡
        async function loadHistory(userId) {
            const { data: logs } = await supabase
                .from('game_logs')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(10);

            const list = document.getElementById('history-list');
            if (!logs || logs.length === 0) {
                document.getElementById('empty-history').style.display = 'block';
                return;
            }

            logs.forEach(log => {
                const row = document.createElement('tr');
                let resultHtml = log.result_amount > 0 
                    ? `<span class="win">+${log.result_amount}</span>` 
                    : `<span class="lose">-${log.bet_amount}</span>`;
                
                const date = new Date(log.created_at);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;

                row.innerHTML = `
                    <td style="font-weight:bold; color:#fff;">${log.game_name}</td>
                    <td>${log.bet_amount}</td>
                    <td>${resultHtml}</td>
                    <td style="color:var(--text-sub); font-size:0.8em;">${dateStr}</td>
                `;
                list.appendChild(row);
            });
        }
    </script>
</body>
</html>