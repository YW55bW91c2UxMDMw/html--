<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINDOSTAR - Time Capsule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- í°íŠ¸ -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Supabase & ì•”í˜¸í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        /* ğŸŒŒ [Deep Space & Ice Theme] */
        :root {
            --bg-deep: #050510;
            --accent: #00d4ff;       /* ë„¤ì˜¨ ì‹œì•ˆ (ì–¼ìŒìƒ‰) */
            --ice-glow: rgba(0, 212, 255, 0.4);
            --glass-bg: rgba(20, 25, 40, 0.6);
            --glass-border: rgba(100, 200, 255, 0.2);
            --text-main: #ffffff;
            --text-sub: #a4a4c5;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', monospace;
            background-color: var(--bg-deep);
            color: var(--text-main);
            /* ìš°ì£¼ ë°°ê²½ */
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ğŸï¸ ìƒë‹¨ ë‰´ìŠ¤ í‹°ì»¤ (íë¥´ëŠ” ë©”ì‹œì§€) */
        .ticker-wrap {
            position: fixed; top: 60px; width: 100%; overflow: hidden; height: 40px;
            background: rgba(0, 20, 40, 0.8); border-bottom: 1px solid var(--accent);
            display: flex; align-items: center; z-index: 90;
            backdrop-filter: blur(5px);
        }
        .ticker {
            display: flex; white-space: nowrap;
            animation: ticker 30s linear infinite;
        }
        .ticker-item {
            margin-right: 50px; color: var(--accent); font-size: 0.9rem;
            display: flex; align-items: center; gap: 10px;
        }
        @keyframes ticker { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .top-bar {
            padding: 15px 20px; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333;
            display: flex; gap: 15px; position: fixed; top: 0; width: 100%; z-index: 100;
        }
        .top-bar a { text-decoration: none; color: var(--text-sub); font-weight: bold; }
        .top-bar a:hover { color: var(--accent); }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1000px; margin: 120px auto 50px auto; padding: 0 20px; }

        .header-title { text-align: center; margin-bottom: 40px; }
        .header-title h1 { font-size: 2.5rem; color: var(--accent); text-shadow: 0 0 20px var(--accent); margin: 0; }
        .header-title p { color: var(--text-sub); margin-top: 10px; }

        /* ğŸ§Š ì–¼ìŒ íë¸Œ ì‘ì„± í¼ */
        .capsule-form {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 30px; max-width: 600px; margin: 0 auto 60px auto;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.1);
            position: relative; overflow: hidden;
        }
        .capsule-form::before {
            content: 'â„ï¸ CRYO-SLEEP SYSTEM'; position: absolute; top: 10px; left: 15px;
            font-size: 0.7rem; color: var(--accent); opacity: 0.7; letter-spacing: 2px;
        }

        input, textarea {
            width: 100%; background: rgba(0, 0, 0, 0.5); border: 1px solid #444;
            color: white; padding: 12px; margin-bottom: 15px; border-radius: 5px;
            font-family: 'Pretendard'; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--ice-glow); }
        
        .freeze-btn {
            width: 100%; padding: 15px; background: linear-gradient(45deg, #00d4ff, #0066ff);
            border: none; border-radius: 5px; color: white; font-weight: 900; font-size: 1.1rem;
            cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .freeze-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--ice-glow); }

        /* ğŸ§Š ìº¡ìŠ ê·¸ë¦¬ë“œ */
        .capsule-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;
        }

        .ice-cube {
            background: rgba(150, 200, 255, 0.05);
            border: 1px solid rgba(150, 200, 255, 0.2);
            border-radius: 12px; padding: 20px; height: 200px;
            position: relative; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; backdrop-filter: blur(5px);
        }
        .ice-cube:hover {
            background: rgba(150, 200, 255, 0.1); border-color: var(--accent);
            transform: translateY(-5px); box-shadow: 0 0 20px var(--ice-glow);
        }

        /* ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .status-frozen { font-size: 3rem; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--accent)); }
        .status-melted { font-size: 3rem; margin-bottom: 10px; filter: drop-shadow(0 0 10px #ffaa00); }
        
        .cube-date { font-size: 0.8rem; color: var(--accent); font-weight: bold; margin-top: 10px; }
        .cube-name { font-size: 0.9rem; color: #fff; margin-top: 5px; }
        .cube-dday { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 0.7rem; background: rgba(0,0,0,0.5); 
            padding: 2px 6px; border-radius: 4px; color: #aaa; 
        }

        /* íŒì—… ëª¨ë‹¬ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .modal-content {
            background: #111; border: 2px solid var(--accent); padding: 40px; border-radius: 20px;
            max-width: 500px; text-align: center; position: relative;
            box-shadow: 0 0 50px var(--ice-glow);
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #666; }
        .msg-text { font-size: 1.2rem; line-height: 1.6; margin: 20px 0; white-space: pre-wrap; }

    </style>
</head>
<body>

    <nav class="top-bar">
        <a href="/">JINDOFLIX</a>
        <a href="/board.html">/b/ ìµëª…ì±„ë„</a>
        <a href="/capsule.html" style="color:var(--accent);">íƒ€ì„ìº¡ìŠ</a>
    </nav>

    <!-- ìƒë‹¨ ë‰´ìŠ¤ í‹°ì»¤ (í•´ë™ëœ ë©”ì‹œì§€) -->
    <div class="ticker-wrap">
        <div class="ticker" id="ticker-content">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì±„ì›Œì§ -->
            <div class="ticker-item">ì‹œìŠ¤í…œ: í•´ë™ëœ ë©”ì‹œì§€ë¥¼ ìŠ¤ìº” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
    </div>

    <div class="container">
        <div class="header-title">
            <h1>CRYO-STORAGE</h1>
            <p>ë””ì§€í„¸ ëƒ‰ë™ ë³´ê´€ì†Œ - ë‹¹ì‹ ì˜ ë©”ì‹œì§€ëŠ” ë¯¸ë˜ì— ì „ë‹¬ë©ë‹ˆë‹¤.</p>
        </div>

        <!-- ìº¡ìŠ ì…ë ¥ í¼ -->
        <div class="capsule-form">
            <div style="display:flex; gap:10px;">
                <input type="text" id="input-name" placeholder="ë‹‰ë„¤ì„ (ìµëª…)" style="flex:1;">
                <!-- ìµœì†Œ 30ì¼ ë’¤ë¶€í„° ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ JSë¡œ ì œì–´ -->
                <input type="date" id="input-date" style="flex:1;">
            </div>
            <textarea id="input-msg" placeholder="ë¯¸ë˜ì˜ ëˆ„êµ°ê°€(í˜¹ì€ ë‚˜)ì—ê²Œ ë‚¨ê¸¸ ë©”ì‹œì§€... (ë´‰ì¸ë˜ë©´ ìˆ˜ì • ë¶ˆê°€)" rows="4"></textarea>
            <button class="freeze-btn" onclick="freezeMessage()">ğŸ§Š FREEZE DATA (ë™ê²°)</button>
            <div style="text-align:center; font-size:0.8rem; color:#666; margin-top:10px;">
                * ìµœì†Œ 30ì¼ê°„ ë´‰ì¸ë©ë‹ˆë‹¤. ë‚´ìš©ì€ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
            </div>
        </div>

        <!-- ìº¡ìŠ ëª©ë¡ -->
        <h2 style="color:white; margin-bottom:20px;">ğŸ“¦ ë³´ê´€ëœ ìº¡ìŠë“¤</h2>
        <div class="capsule-grid" id="capsule-list">
            <div style="color:#666; grid-column: 1/-1; text-align:center;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ í™•ì¸ ëª¨ë‹¬ -->
    <div id="msg-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('msg-modal').style.display='none'">&times;</span>
            <div style="font-size:3rem; margin-bottom:10px;">ğŸ’Œ</div>
            <h3 id="modal-title" style="color:var(--accent); margin:0;">í•´ë™ ì™„ë£Œ!</h3>
            <div id="modal-text" class="msg-text"></div>
            <div id="modal-date" style="font-size:0.8rem; color:#666;"></div>
        </div>
    </div>

    <script>
        // 1. Supabase ì„¤ì •
        const supabaseUrl = 'https://ë³¸ì¸ì£¼ì†Œ.supabase.co'
        const supabaseKey = 'eyJë¡œ_ì‹œì‘í•˜ëŠ”_ê¸´_í‚¤'
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);

        // [ì¤‘ìš”] ì´ì œ í•˜ë“œì½”ë”©ëœ SECRET_KEYëŠ” ì—†ìŠµë‹ˆë‹¤. ìœ ì €ê°€ ì…ë ¥í•œ ë¹„ë²ˆì´ í‚¤ê°€ ë©ë‹ˆë‹¤.

        // 3. ë‚ ì§œ ì œí•œ ì„¤ì • (ì˜¤ëŠ˜ + 30ì¼)
        const today = new Date();
        const minDate = new Date(today.setDate(today.getDate() + 30));
        const minDateString = minDate.toISOString().split('T')[0];
        document.getElementById('input-date').min = minDateString;
        document.getElementById('input-date').value = minDateString; 

        // 4. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCapsules() {
            const { data, error } = await client
                .from('timecapsules')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) return console.error(error);

            const grid = document.getElementById('capsule-list');
            const ticker = document.getElementById('ticker-content');
            grid.innerHTML = '';
            ticker.innerHTML = ''; 

            let hasOpenedMsg = false;

            data.forEach(cap => {
                const unlockDate = new Date(cap.unlock_date);
                const now = new Date();
                // ê´€ë¦¬ìê°€ ê°•ì œ í•´ë™(is_frozen=false) í–ˆê±°ë‚˜ ë‚ ì§œê°€ ì§€ë‚¬ìœ¼ë©´ í•´ë™ ìƒíƒœ
                const isUnlocked = (now >= unlockDate) || !cap.is_frozen; 
                
                const diffTime = unlockDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let dDayText = diffDays > 0 ? `D-${diffDays}` : `OPEN`;

                const card = document.createElement('div');
                card.className = 'ice-cube';
                
                if (isUnlocked) {
                    // [í•´ë™ë¨] - í´ë¦­í•˜ë©´ ë¹„ë°€ë²ˆí˜¸ ë¬¼ì–´ë´„
                    card.innerHTML = `
                        <div class="status-melted">ğŸ’§</div>
                        <div class="cube-name" style="color:#ffcc00;">${cap.nickname}</div>
                        <div class="cube-date">í•´ë™ ì™„ë£Œ</div>
                        <div class="cube-dday" style="background:#ffcc00; color:black;">UNLOCKED</div>
                    `;
                    card.onclick = () => openMessage(cap); 

                    // í‹°ì»¤ì—ëŠ” "ëˆ„êµ°ê°€ì˜ ìº¡ìŠì´ ì—´ë ¸ìŠµë‹ˆë‹¤" ì •ë„ë§Œ í‘œì‹œ (ë‚´ìš©ì€ ì•”í˜¸í™”ë¼ì„œ ëª» ë³´ì—¬ì¤Œ)
                    const tickerItem = document.createElement('div');
                    tickerItem.className = 'ticker-item';
                    tickerItem.innerText = `ğŸ“¢ [${cap.nickname}]ë‹˜ì˜ ìº¡ìŠ ë´‰ì¸ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤! (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)`;
                    ticker.appendChild(tickerItem);
                    hasOpenedMsg = true;
                } else {
                    // [ëƒ‰ë™ì¤‘]
                    card.innerHTML = `
                        <div class="status-frozen">ğŸ§Š</div>
                        <div class="cube-name">${cap.nickname}</div>
                        <div class="cube-date">${unlockDate.toLocaleDateString()} ê³µê°œ</div>
                        <div class="cube-dday">${dDayText}</div>
                    `;
                    card.onclick = () => alert(`â„ï¸ ì´ ë°ì´í„°ëŠ” ë™ê²° ìƒíƒœì…ë‹ˆë‹¤.\n[${unlockDate.toLocaleDateString()}]ê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
                }
                grid.appendChild(card);
            });

            if (!hasOpenedMsg) {
                ticker.innerHTML = '<div class="ticker-item">ì‹œìŠ¤í…œ: í˜„ì¬ í•´ë™ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ìš°ì£¼ê°€ ì¡°ìš©í•©ë‹ˆë‹¤... ğŸŒŒ</div>';
            }
        }

        // 5. ë©”ì‹œì§€ ë™ê²° (E2EE ì•”í˜¸í™”)
        async function freezeMessage() {
            const nickname = document.getElementById('input-name').value || 'ìµëª…';
            const content = document.getElementById('input-msg').value;
            const dateVal = document.getElementById('input-date').value;

            if (!content) return alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            if (!dateVal) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
            
            // [í•µì‹¬] ì‚¬ìš©ìì—ê²Œ ë¹„ë°€ë²ˆí˜¸ ë°›ê¸°
            const userPass = prompt("ğŸ”’ ì´ ìº¡ìŠì„ ì ê¸€ 'ë¹„ë°€ë²ˆí˜¸'ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.\n(ì£¼ì˜: ë‚˜ì¤‘ì— ì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë¥´ë©´ ì ˆëŒ€ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)");
            if (!userPass) return alert("ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");

            // [í•µì‹¬] ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¡œ ì•”í˜¸í™” (AES)
            const encrypted = CryptoJS.AES.encrypt(content, userPass).toString();

            const { error } = await client.from('timecapsules').insert({
                nickname: nickname,
                content: encrypted, // ì•”í˜¸í™”ëœ í…ìŠ¤íŠ¸ë§Œ ì„œë²„ë¡œ ì „ì†¡ë¨
                unlock_date: dateVal,
                is_frozen: true
            });

            if (error) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            } else {
                alert("ğŸ§Š ìº¡ìŠì´ ë™ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!\nì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¼­ ê¸°ì–µí•˜ì„¸ìš”.");
                location.reload();
            }
        }

        // 6. ë©”ì‹œì§€ í•´ë™ (E2EE ë³µí˜¸í™”)
        function openMessage(cap) {
            // [í•µì‹¬] ì‚¬ìš©ìì—ê²Œ ë¹„ë°€ë²ˆí˜¸ ë¬¼ì–´ë³´ê¸°
            const inputPass = prompt(`ğŸ”’ [${cap.nickname}]ë‹˜ì˜ ìº¡ìŠì…ë‹ˆë‹¤.\në‚´ìš©ì„ ë³´ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            
            if (!inputPass) return;

            try {
                // [í•µì‹¬] ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³µí˜¸í™” ì‹œë„
                const bytes = CryptoJS.AES.decrypt(cap.content, inputPass);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);

                // ë³µí˜¸í™” ì„±ê³µ ì‹œ ë‚´ìš©ì´ ìˆìŒ, ì‹¤íŒ¨ ì‹œ ë¹ˆ ë¬¸ìì—´
                if (!originalText) throw new Error("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");

                document.getElementById('modal-title').innerText = "ğŸ‰ í•´ë™ ì„±ê³µ!";
                document.getElementById('modal-text').innerText = originalText;
                document.getElementById('modal-date').innerText = `ì‘ì„±ì: ${cap.nickname} | ì›ë˜ ê³µê°œì¼: ${new Date(cap.unlock_date).toLocaleDateString()}`;
                document.getElementById('msg-modal').style.display = 'flex';
            
            } catch (e) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì˜¬ë°”ë¥¸ í‚¤ê°€ ì—†ìœ¼ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)");
            }
        }

        function closeModal(e) {
            if (e.target.id === 'msg-modal') {
                document.getElementById('msg-modal').style.display = 'none';
            }
        }

        loadCapsules();
    </script>

</body>
</html>